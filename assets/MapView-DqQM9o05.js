import{s as C,u as z,_ as H,c as g,o as y,a as o,b as S,w as se,F as B,r as O,n as D,t as T,d as ie,e as I,f as P,g as X,h as J,i as K,j as ne,k as G,l as le,m as ce,p as re}from"./main-V_1wxRPJ.js";import{i as V,m as Y,M as Q,g as ee,e as ue,a as de,b as ve}from"./Message-C6PSr0gm.js";import{m as N}from"./material_config-Bu-F0gt6.js";const pe=(k,i,s=0)=>{const e=k-i;let b;e<-3?b=0:e>6?b=2:b=(e+3)/4.5;const d=i-s;let l;return d<-3?l=0:d>3?l=1:l=(d+3)/6,Math.min(Math.max(.5*b*l,0),1)},me=(k,i,s)=>{const e=Object.keys(V.equipment_levels),b=Math.random();let d=0;for(const l of e){let _=V.equipment_levels[l].chance;if(s<.7){if(["epic","legendary","mythic"].includes(l)&&Math.random()>.5)return"rare"}else if(s<.8){if(["legendary","mythic"].includes(l)&&Math.random()>.5)return"epic"}else if(s<.9&&l==="mythic"&&Math.random()>.5)return"legendary";if(d+=_,b<=d)return l}return"common"},fe=(k,i,s)=>{const e=V.equipment_position[k],d=V.equipment_levels[s].name,l=i.reduce((_,M)=>M.materialLevel>_.materialLevel?M:_);let h="未知";for(const _ in N.material_types){const M=N.material_types[_].materials;if(M[l.materialId]){h=M[l.materialId].name;break}}return`${d}${h}${e.name}`},he=(k,i,s,e)=>{for(const b in N.material_types){const d=N.material_types[b],l=d.materials;if(l[k]){const h=l[k],_={},p=V.equipment_position[s].stat_multipliers||{};for(const n in d.base_stats){let t=Math.ceil(d.base_stats[n]*h.multiplier*h.level*i*2*(p[n]||1));if(!["crit_rate","crit_resist","hit_rate","dodge_rate"].includes(n)){const $=V.equipment_levels[e].multiplier;t=Math.ceil(t*$)}_[n]=t}return _}}return null},te=async k=>{const i=[...C.player.materials];k.forEach(s=>{const e=i.indexOf(s);e!==-1&&i.splice(e,1)}),await z({materials:i})},_e=async({materials:k,forgerLevel:i,toolLevel:s,equipmentType:e})=>{if(!k||k.length===0||k.length>5)return{success:!1,message:"材料数量必须在1-5之间"};if(!V.equipment_position[e])return{success:!1,message:"无效的装备类型"};const d=k.map(p=>{let n=0;for(const $ in N.material_types){const m=N.material_types[$].materials;if(m[p]){n=m[p].level;break}}const t=pe(i,s,n);return{materialId:p,success:Math.random()<t,successRate:t,materialLevel:n}}).filter(p=>p.success);if(d.length===0)return await te(k),{success:!1,message:"锻造失败，所有材料都未能成功融合"};const l=d.reduce((p,n)=>n.materialLevel>p.materialLevel?n:p),h=me(i,s,l.successRate),_={type:e,position:e,level:h,combat_info:{}},M=new Set;for(const p in N.material_types){const n=N.material_types[p].base_stats;for(const t in n)M.add(t)}return M.forEach(p=>{_.combat_info[p]=0}),d.forEach(p=>{const n=he(p.materialId,p.successRate,e,h);n&&Object.keys(n).forEach(t=>{_.combat_info[t]+=n[t]})}),_.name=fe(e,d,h),C.player.unequipped.push(_),await te(k),{success:!0,message:`锻造成功！${d.length}个材料成功融合`,equipment:_}},ye={name:"ForgeView",emits:["close"],setup(k,{emit:i}){const s=I([]),e=I(""),b=I(null),d=I(!1),l=V.equipment_position,h=P(()=>C.player.materials);X(h,()=>{s.value=[],e.value=""});const _=m=>{for(const f in N.material_types){const x=N.material_types[f].materials;if(x[m])return x[m].name}return m},M=(m,f)=>{s.value.findIndex(E=>E.index===f)!==-1?p(f):s.value.length<5&&s.value.push({material:m,index:f})},p=m=>{s.value=s.value.filter(f=>f.index!==m)};return{availableMaterials:h,selectedMaterials:s,selectedType:e,equipmentTypes:l,forgeResult:b,getMaterialName:_,toggleMaterial:M,removeMaterial:p,selectEquipmentType:m=>{e.value=m},startForge:async()=>{if(!(!e.value||s.value.length===0||s.value.length>5||d.value)){d.value=!0;try{const m=C.player.forgerLevel||1,f=C.player.toolLevel||1,x=await _e({materials:s.value.map(E=>E.material),forgerLevel:m,toolLevel:f,equipmentType:e.value});b.value=x,s.value=[],e.value=""}finally{d.value=!1}}},handleCloseClick:m=>{const f=m.currentTarget.getBoundingClientRect();m.clientY-f.top<100&&i("close")}}}},ge={class:"forge-view-container"},be={class:"forge-view"},we={class:"forge-header"},ke={class:"equipment-type-selection"},Ce={class:"equipment-types"},Me=["onClick"],$e={class:"materials-selection"},xe={class:"materials-list"},Ie=["onClick"],Le={key:0,class:"selected-materials"},Ee={class:"selected-list"},je=["onClick"],qe=["disabled"],Te={key:0,class:"equipment-stats"};function Re(k,i,s,e,b,d){return y(),g("div",ge,[o("div",be,[o("div",we,[i[2]||(i[2]=o("div",{class:"forge-title"},"装备锻造",-1)),o("button",{class:"close-button",onClick:i[0]||(i[0]=se((...l)=>e.handleCloseClick&&e.handleCloseClick(...l),["stop"]))},"×")]),o("div",ke,[i[3]||(i[3]=o("div",{class:"section-title"},"选择装备类型",-1)),o("div",Ce,[(y(!0),g(B,null,O(e.equipmentTypes,(l,h)=>(y(),g("div",{key:h,class:D(["equipment-type-item",{selected:e.selectedType===h}]),onClick:_=>e.selectEquipmentType(h)},T(l.name),11,Me))),128))])]),o("div",$e,[i[4]||(i[4]=o("div",{class:"section-title"},"选择材料 (1-5件)",-1)),o("div",xe,[(y(!0),g(B,null,O(e.availableMaterials,(l,h)=>(y(),g("div",{key:h,class:D(["material-item",{selected:e.selectedMaterials.some(_=>_.index===h)}]),onClick:_=>e.toggleMaterial(l,h)},T(e.getMaterialName(l)),11,Ie))),128))])]),e.selectedMaterials.length>0?(y(),g("div",Le,[i[5]||(i[5]=o("div",{class:"section-title"},"已选材料",-1)),o("div",Ee,[(y(!0),g(B,null,O(e.selectedMaterials,(l,h)=>(y(),g("div",{key:h,class:"selected-item"},[ie(T(e.getMaterialName(l.material))+" ",1),o("button",{onClick:_=>e.removeMaterial(l.index)},"移除",8,je)]))),128))])])):S("",!0),o("button",{class:"forge-button",onClick:i[1]||(i[1]=(...l)=>e.startForge&&e.startForge(...l)),disabled:e.selectedMaterials.length===0||e.selectedMaterials.length>5}," 开始锻造 ",8,qe),e.forgeResult?(y(),g("div",{key:1,class:D(["forge-result",e.forgeResult.success?"success":"fail"])},[i[6]||(i[6]=o("div",{class:"section-title"},"锻造结果",-1)),o("p",null,T(e.forgeResult.message),1),e.forgeResult.equipment?(y(),g("div",Te,[o("p",null,"获得装备："+T(e.forgeResult.equipment.name),1)])):S("",!0)],2)):S("",!0)])])}const Se=H(ye,[["render",Re],["__scopeId","data-v-143880b7"]]),Ne={potion_001:{id:"potion_001",name:"小型生命药水",description:"恢复少量生命值的药水",effect:{type:"hp",value:50}},potion_002:{id:"potion_002",name:"中型生命药水",description:"恢复中等生命值的药水",effect:{type:"hp",value:100}},potion_003:{id:"potion_003",name:"大型生命药水",description:"恢复大量生命值的药水",effect:{type:"hp",value:200}}},Pe={potions:Ne},Ve={class:"shop-view-container"},Be={class:"shop-content"},Oe={class:"shop-section"},Fe={class:"shop-grid"},Ae=["onClick"],We={class:"item-name"},De={class:"item-price"},Ye={class:"inventory-section"},Xe={class:"inventory-grid"},He=["onClick"],ze={class:"item-name"},Ke={class:"item-price"},Ge={key:0,class:"item-count"},Je={__name:"ShopView",emits:["close"],setup(k,{emit:i}){const s=i,e=P(()=>Y[C.currentMapId]),b=P(()=>{var c;return(c=e.value)==null?void 0:c.locations[C.currentLocationId]}),d=P(()=>{var w,v,L;return(((L=(v=(w=b.value)==null?void 0:w.npc)==null?void 0:v.shop)==null?void 0:L.items)||[]).map(r=>{const a=Pe.potions[r.id];return{...r,name:a.name,description:a.description,effect:a.effect}})}),l=P(()=>{const w=(C.player.materials||[]).reduce((v,L)=>(v[L]=(v[L]||0)+1,v),{});return Object.entries(w).map(([v,L])=>{for(const r of Object.values(N.material_types)){const a=r.materials[v];if(a)return{id:v,name:a.name,level:a.level,type:r.name,count:L}}return null}).filter(Boolean)}),h=c=>100*c.level,_=I(!1),M=I(""),p=I("info"),n=I(!1),t=I("确定"),$=I(()=>{}),m=c=>{M.value=`${c.name}<br>${c.description}<br>价格: ${c.price} 金币`,p.value="info",_.value=!0,n.value=!0,t.value="购买",$.value=()=>x(c)},f=c=>{const w=h(c);M.value=`${c.name}<br>类型: ${c.type}<br>等级: ${c.level}<br>售价: ${w} 金币`,p.value="info",_.value=!0,n.value=!0,t.value="出售",$.value=()=>E(c)},x=async c=>{if(C.player.gold<c.price){K(()=>{M.value="金币不足！",p.value="error",n.value=!1,_.value=!0});return}const w={...C.player};w.gold-=c.price,w.potions.push(c),await z(w),K(()=>{M.value="购买成功！",p.value="success",n.value=!1,_.value=!0})},E=async c=>{const w=h(c),v={...C.player};v.gold+=w;const L=v.materials.findIndex(r=>r===c.id);L!==-1?(v.materials.splice(L,1),await z(v),M.value=`出售成功！获得 ${w} 金币`,p.value="success"):(M.value="出售失败！",p.value="error"),n.value=!1},q=()=>{$.value()},R=()=>{s("close")};return(c,w)=>(y(),g("div",Ve,[o("div",{class:"shop-header"},[w[0]||(w[0]=o("div",{class:"title"},"商店",-1)),o("div",{class:"close-button",onClick:R},"×")]),o("div",Be,[o("div",Oe,[o("div",Fe,[(y(!0),g(B,null,O(d.value,v=>(y(),g("div",{key:v.id,class:"shop-item",onClick:L=>m(v)},[o("div",We,T(v.name),1),o("div",De,T(v.price)+" 金币",1)],8,Ae))),128))])]),o("div",Ye,[o("div",Xe,[(y(!0),g(B,null,O(l.value,v=>(y(),g("div",{key:v.id,class:"inventory-item",onClick:L=>f(v)},[o("div",ze,T(v.name),1),o("div",Ke,T(h(v))+" 金币",1),v.count>1?(y(),g("div",Ge,"x"+T(v.count),1)):S("",!0)],8,He))),128))])])]),J(Q,{visible:_.value,content:M.value,type:p.value,"show-button":n.value,"button-text":t.value,onAction:q},null,8,["visible","content","type","show-button","button-text"])]))}},Qe=H(Je,[["__scopeId","data-v-7faaa296"]]),Ue={class:"location-container"},Ze={class:"content-wrapper"},et={class:"location-header"},tt={class:"location-title"},st={class:"combat-log"},nt={class:"combat-log-content"},at={key:0,class:"tab-container"},ot={key:1,class:"enemies-list"},it={class:"enemies-list-content"},lt=["onClick"],ct=["onClick","disabled"],rt={key:2,class:"npcs-list"},ut={class:"npcs-list-content"},dt=["onClick"],vt={key:0,class:"enter-button"},pt={__name:"LocationView",emits:["close"],setup(k,{emit:i}){const s=I("enemies");ee();const e=P(()=>Y[C.currentMapId].locations[C.currentLocationId]),b=I([]),d=I(!1),l=P(()=>Object.entries(C.enemyStatus).filter(([r,a])=>a.locationId===C.currentLocationId).map(([r,a])=>{const u=a.enemyId,j=ue.creatures[u];return{instanceId:r,creatureId:u,name:j.name,desc:j.desc,hp:a.hp}})),h=i;ne(()=>{b.value.push({id:Date.now(),message:`${e.value.description||""}`}),c()});const _=()=>{h("close")},M=r=>({forge:"锻造所",shop:"商店"})[r]||r,p=I(!1),n=I(!1),t=r=>{r==="forge"?p.value=!0:r==="shop"&&(n.value=!0)},$=()=>{p.value=!1},m=()=>{n.value=!1},f=(r,a=500)=>new Promise(u=>{setTimeout(()=>{b.value.push({id:Date.now(),message:r}),u()},a)}),x=async r=>{if(!d.value){d.value=!0;try{const a=await ve(r.instanceId);if(!a.player.hit)await f(`你的攻击未命中${r.name}`);else{let u=`你对${r.name}造成了${a.player.damage}点伤害`;if(a.player.isCrit&&(u+="（暴击！）"),await f(u),!C.enemyStatus[r.instanceId]){if(await f(`${r.name}被击败了！`),a.drops&&a.drops.length>0){const j=a.drops.map(F=>{for(const A in N.material_types){const W=N.material_types[A];if(W.materials[F])return W.materials[F].name}return F}).join("、");await f(`获得了：${j}`)}ee();return}}if(a.enemy)if(!a.enemy.hit)await f(`${r.name}的反击未命中你`);else{let u=`${r.name}反击对你造成了${a.enemy.damage}点伤害`;if(a.enemy.isCrit&&(u+="（暴击！）"),await f(u),!a.enemy.isPlayerAlive){await f("你被击败了，装备材料掉了一地，太可惜了");return}}}catch(a){console.error("Attack failed:",a),await f("你脚下一滑，攻击没有发起")}finally{d.value=!1}}};X(b,()=>{K(()=>{const r=document.querySelector(".combat-log-content");r&&(r.scrollTop=r.scrollHeight)})},{deep:!0});const q=P(()=>l.value.length>0),R=P(()=>e.value.npc&&Object.keys(e.value.npc).length>0),c=()=>{s.value==="enemies"&&!q.value?s.value=R.value?"npcs":null:s.value==="npcs"&&!R.value&&(s.value=q.value?"enemies":null)};X([q,R],()=>{c()});const w=I(!1),v=I(""),L=r=>{const a=r.creatureId,u=de(a);let j=`${r.name}<br>`;for(const[F,A]of Object.entries(u))j+=`${V.combat_stats[F]}: ${A}<br>`;v.value=j.trim(),w.value=!0};return(r,a)=>(y(),g("div",null,[o("div",{class:"overlay",onClick:_}),o("div",Ue,[o("div",Ze,[o("div",et,[o("div",tt,T(e.value.name),1)]),o("div",st,[a[2]||(a[2]=o("div",{class:"section-title"},"探索日志",-1)),o("div",nt,[(y(!0),g(B,null,O(b.value,u=>(y(),g("div",{key:u.id},T(u.message),1))),128))])]),q.value||R.value?(y(),g("div",at,[q.value?(y(),g("div",{key:0,class:D(["tab-item",{active:s.value==="enemies"}]),onClick:a[0]||(a[0]=u=>s.value="enemies")}," 生物列表 ",2)):S("",!0),R.value?(y(),g("div",{key:1,class:D(["tab-item",{active:s.value==="npcs"}]),onClick:a[1]||(a[1]=u=>s.value="npcs")}," NPC列表 ",2)):S("",!0)])):S("",!0),s.value==="enemies"&&q.value?(y(),g("div",ot,[o("div",it,[(y(!0),g(B,null,O(l.value,u=>(y(),g("div",{key:u.instanceId,class:"enemy-item",onClick:j=>L(u)},[o("span",null,T(u.name)+" (HP: "+T(u.hp)+")",1),o("button",{onClick:se(j=>x(u),["stop"]),disabled:d.value}," 攻击 ",8,ct)],8,lt))),128))])])):S("",!0),s.value==="npcs"&&e.value.npc&&R.value?(y(),g("div",rt,[o("div",ut,[(y(!0),g(B,null,O(e.value.npc,(u,j)=>(y(),g("div",{key:j,class:"npc-item",onClick:F=>t(j)},[o("span",null,T(M(j)),1),j==="forge"||j==="shop"?(y(),g("button",vt,"进入")):S("",!0)],8,dt))),128))])])):S("",!0)])]),p.value?(y(),G(Se,{key:0,class:"npc-view",onClose:$})):S("",!0),n.value?(y(),G(Qe,{key:1,class:"npc-view",onClose:m})):S("",!0),J(Q,{visible:w.value,content:v.value,type:"info","show-button":!1},null,8,["visible","content"])]))}},mt=H(pt,[["__scopeId","data-v-f536a77c"]]),ft=async k=>{const i=C.currentLocationId;if(i===k)return;const s=Y[C.currentMapId].locations[i],e=Y[C.currentMapId].locations[k];if(!s||!e)return Promise.reject(new Error("无效的位置ID"));if(!s.adjacent_locations.includes(Number(k)))return Promise.reject(new Error(`无法移动到${e.name}，该位置与当前位置不相邻`));const b=Math.sqrt(Math.pow(e.position.x-s.position.x,2)+Math.pow(e.position.y-s.position.y,2)),d=Math.floor(b/50*1e3);await new Promise(l=>{setTimeout(()=>{l()},d)}),le({currentLocationId:k})},ht={__name:"MapView",setup(k){const i=I(null),s=I(!1),e=Y[C.currentMapId],b=e.locations,d=I(!1),l=I(""),h=(n,t,$,m,f,x,E,q,R)=>{const c=Math.atan2(m-t,$-n),w=f+E/2,v=x+q/2,L=E/2,r=q/2;let a,u;return Math.abs(Math.tan(c))*L<=r?(a=Math.cos(c)>0?f+E:f,u=v+Math.tan(c)*(a-w)):(u=Math.sin(c)>0?x+q:x,a=w+(u-v)/Math.tan(c)),{x:a,y:u}},_=()=>{const n=i.value,t=n.getContext("2d");t.clearRect(0,0,n.width,n.height),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,n.width,n.height);const $=new Set;Object.values(b).forEach(m=>{const f=m.position.x,x=m.position.y;t.font="16px Arial",t.textAlign="center";const E=m.name||"未命名",q=t.measureText(E).width,R=10,c=q+R*2,w=30,v=f-c/2,L=x-w/2;m.adjacent_locations.forEach(r=>{const a=[m.id,r].sort().join("-");if(!$.has(a)){const u=b[r];if(u){const j=u.name||"未命名",A=t.measureText(j).width+R*2,W=30,ae=u.position.x-A/2,oe=u.position.y-W/2,U=h(f,x,u.position.x,u.position.y,v,L,c,w),Z=h(u.position.x,u.position.y,f,x,ae,oe,A,W);t.beginPath(),t.moveTo(U.x,U.y),t.lineTo(Z.x,Z.y),t.strokeStyle="#ffd700",t.lineWidth=2,t.stroke(),$.add(a)}}}),t.beginPath(),t.strokeStyle=C.currentLocationId===m.id?"#ff4444":"#ffd700",t.lineWidth=2,t.roundRect(v,L,c,w,8),t.stroke(),Number(C.currentLocationId)===Number(m.id)&&(t.save(),t.shadowColor="#ff4444",t.shadowBlur=10,t.shadowOffsetX=0,t.shadowOffsetY=0,t.strokeStyle="#ff4444",t.lineWidth=2,t.roundRect(v,L,c,w,8),t.stroke(),t.restore()),t.fillStyle="white",t.fillText(E,f,x+5)})},M=async n=>{const $=i.value.getBoundingClientRect(),m=n.clientX-$.left,f=n.clientY-$.top;Object.keys(b).forEach(async x=>{const E=b[x],q=E.position.x,R=E.position.y;if(Math.abs(m-q)<20&&Math.abs(f-R)<20)try{d.value=!0,l.value=`正在前往${E.name}...`,await ft(x),d.value=!1,s.value=!0}catch(c){l.value=c.message,setTimeout(()=>{d.value=!1},2e3)}})},p=()=>{const t=i.value.parentElement,$=b[C.currentLocationId];if($){const m=$.position.x,f=$.position.y,x=m-t.clientWidth/2,E=f-t.clientHeight/2;t.scrollTo({left:x,top:E,behavior:"smooth"})}};return ne(()=>{const n=i.value;n.width=e.width,n.height=e.height,_(),n.addEventListener("click",M),p()}),X(()=>C.currentLocationId,_),(n,t)=>(y(),g("div",{class:"map-container",style:ce({backgroundImage:`url(${re(e).bg_image})`})},[o("canvas",{ref_key:"mapCanvas",ref:i,class:"map-canvas"},null,512),s.value?(y(),G(mt,{key:0,onClose:t[0]||(t[0]=$=>s.value=!1)})):S("",!0),o("button",{class:"focus-button",onClick:p},t[1]||(t[1]=[o("span",{class:"focus-icon"},"📍",-1)])),J(Q,{visible:d.value,content:l.value,type:"info","show-button":!1,"allow-close":!1},null,8,["visible","content"])],4))}},bt=H(ht,[["__scopeId","data-v-f16eca8e"]]);export{bt as default};
