import{s as M,u as J,_ as G,c as _,o as p,a as o,b as S,w as ne,F as D,r as Y,n as U,t as R,d as oe,e as L,f as F,g as Z,m as K,h as ee,i as z,j as ie,k as ae,l as Q,p as le,q as ce,v as re,x as ue,y as de,z as ve}from"./main-BLzbguFa.js";import{m as N,p as me}from"./potion_config-xlKXEzcY.js";import{i as A,M as te}from"./Message-DeKqoyIn.js";const pe=(k,i,s=0)=>{const t=k-i;let f;t<-3?f=0:t>3?f=2:f=(t+3)/3;const r=i-s;let a;return r<-3?a=0:r>3?a=1:a=(r+3)/6,Math.min(Math.max(.5*f*a,0),1)},fe=(k,i,s)=>{const t=Object.keys(A.equipment_levels),f=Math.random();let r=0;for(const a of t){let d=A.equipment_levels[a].chance;if(s<.7){if(["epic","legendary","mythic"].includes(a)&&Math.random()>.5)return"rare"}else if(s<.8){if(["legendary","mythic"].includes(a)&&Math.random()>.5)return"epic"}else if(s<.9&&a==="mythic"&&Math.random()>.5)return"legendary";if(r+=d,f<=r)return a}return"common"},he=(k,i,s)=>{const t=A.equipment_position[k],r=A.equipment_levels[s].name,a=i.reduce((d,x)=>x.materialLevel>d.materialLevel?x:d);let v="未知";for(const d in N.material_types){const x=N.material_types[d].materials;if(x[a.materialId]){v=x[a.materialId].name;break}}return`${r}${v}${t.name}`},ye=(k,i,s,t)=>{for(const f in N.material_types){const r=N.material_types[f],a=r.materials;if(a[k]){const v=a[k],d={},y=A.equipment_position[s].stat_multipliers||{};for(const n in r.base_stats){let e=Math.ceil(r.base_stats[n]*v.multiplier*v.level*i*2*(y[n]||1));if(!["crit_rate","crit_resist","hit_rate","dodge_rate"].includes(n)){const C=A.equipment_levels[t].multiplier;e=Math.ceil(e*C)}d[n]=e}return d}}return null},se=async k=>{const i=[...M.player.materials];k.forEach(s=>{const t=i.indexOf(s);t!==-1&&i.splice(t,1)}),await J({materials:i})},ge=async({materials:k,forgerLevel:i,toolLevel:s,equipmentType:t})=>{if(!k||k.length===0||k.length>5)return{success:!1,message:"材料数量必须在1-5之间"};if(!A.equipment_position[t])return{success:!1,message:"无效的装备类型"};const r=k.map(y=>{let n=0;for(const C in N.material_types){const m=N.material_types[C].materials;if(m[y]){n=m[y].level;break}}const e=pe(i,s,n);return{materialId:y,success:Math.random()<e,successRate:e,materialLevel:n}}).filter(y=>y.success);if(r.length===0)return await se(k),{success:!1,message:"锻造失败，所有材料都未能成功融合"};const a=r.reduce((y,n)=>n.materialLevel>y.materialLevel?n:y),v=fe(i,s,a.successRate),d={type:t,position:t,level:v,combat_info:{}},x=new Set;for(const y in N.material_types){const n=N.material_types[y].base_stats;for(const e in n)x.add(e)}return x.forEach(y=>{d.combat_info[y]=0}),r.forEach(y=>{const n=ye(y.materialId,y.successRate,t,v);n&&Object.keys(n).forEach(e=>{d.combat_info[e]+=n[e]})}),d.name=he(t,r,v),M.player.unequipped.push(d),await se(k),{success:!0,message:`锻造成功！${r.length}个材料成功融合`,equipment:d}},_e={name:"ForgeView",emits:["close"],setup(k,{emit:i}){const s=L([]),t=L(""),f=L(null),r=L(!1),a=A.equipment_position,v=F(()=>M.player.materials);Z(v,()=>{s.value=[],t.value=""});const d=m=>{for(const w in N.material_types){const b=N.material_types[w].materials;if(b[m])return b[m].name}return m},x=(m,w)=>{s.value.findIndex(E=>E.index===w)!==-1?y(w):s.value.length<5&&s.value.push({material:m,index:w})},y=m=>{s.value=s.value.filter(w=>w.index!==m)};return{availableMaterials:v,selectedMaterials:s,selectedType:t,equipmentTypes:a,forgeResult:f,getMaterialName:d,toggleMaterial:x,removeMaterial:y,selectEquipmentType:m=>{t.value=m},startForge:async()=>{if(!(!t.value||s.value.length===0||s.value.length>5||r.value)){r.value=!0;try{const m=M.player.forgerLevel||1,w=M.player.toolLevel||1,b=await ge({materials:s.value.map(E=>E.material),forgerLevel:m,toolLevel:w,equipmentType:t.value});f.value=b,s.value=[],t.value=""}finally{r.value=!1}}},handleCloseClick:m=>{const w=m.currentTarget.getBoundingClientRect();m.clientY-w.top<100&&i("close")}}}},be={class:"forge-view-container"},we={class:"forge-view"},ke={class:"forge-header"},Ce={class:"equipment-type-selection"},Me={class:"equipment-types"},xe=["onClick"],$e={class:"materials-selection"},Ie={class:"materials-list"},Le=["onClick"],Ee={key:0,class:"selected-materials"},je={class:"selected-list"},qe=["onClick"],Te=["disabled"],Re={key:0,class:"equipment-stats"};function Se(k,i,s,t,f,r){return p(),_("div",be,[o("div",we,[o("div",ke,[i[2]||(i[2]=o("div",{class:"forge-title"},"装备锻造",-1)),o("button",{class:"close-button",onClick:i[0]||(i[0]=ne((...a)=>t.handleCloseClick&&t.handleCloseClick(...a),["stop"]))},"×")]),o("div",Ce,[i[3]||(i[3]=o("div",{class:"section-title"},"选择装备类型",-1)),o("div",Me,[(p(!0),_(D,null,Y(t.equipmentTypes,(a,v)=>(p(),_("div",{key:v,class:U(["equipment-type-item",{selected:t.selectedType===v}]),onClick:d=>t.selectEquipmentType(v)},R(a.name),11,xe))),128))])]),o("div",$e,[i[4]||(i[4]=o("div",{class:"section-title"},"选择材料 (1-5件)",-1)),o("div",Ie,[(p(!0),_(D,null,Y(t.availableMaterials,(a,v)=>(p(),_("div",{key:v,class:U(["material-item",{selected:t.selectedMaterials.some(d=>d.index===v)}]),onClick:d=>t.toggleMaterial(a,v)},R(t.getMaterialName(a)),11,Le))),128))])]),t.selectedMaterials.length>0?(p(),_("div",Ee,[i[5]||(i[5]=o("div",{class:"section-title"},"已选材料",-1)),o("div",je,[(p(!0),_(D,null,Y(t.selectedMaterials,(a,v)=>(p(),_("div",{key:v,class:"selected-item"},[oe(R(t.getMaterialName(a.material))+" ",1),o("button",{onClick:d=>t.removeMaterial(a.index)},"移除",8,qe)]))),128))])])):S("",!0),o("button",{class:"forge-button",onClick:i[1]||(i[1]=(...a)=>t.startForge&&t.startForge(...a)),disabled:t.selectedMaterials.length===0||t.selectedMaterials.length>5}," 开始锻造 ",8,Te),t.forgeResult?(p(),_("div",{key:1,class:U(["forge-result",t.forgeResult.success?"success":"fail"])},[i[6]||(i[6]=o("div",{class:"section-title"},"锻造结果",-1)),o("p",null,R(t.forgeResult.message),1),t.forgeResult.equipment?(p(),_("div",Re,[o("p",null,"获得装备："+R(t.forgeResult.equipment.name),1)])):S("",!0)],2)):S("",!0)])])}const Ne=G(_e,[["render",Se],["__scopeId","data-v-143880b7"]]),Pe={class:"shop-view-container"},Oe={class:"shop-content"},Ve={class:"shop-section"},Be={class:"shop-grid"},Fe=["onClick"],Ae={class:"item-name"},We={class:"item-price"},De={class:"inventory-section"},Ye={class:"inventory-grid"},Xe=["onClick"],He={class:"item-name"},ze={class:"item-price"},Ue={key:0,class:"item-count"},Ke={__name:"ShopView",emits:["close"],setup(k,{emit:i}){const s=i,t=F(()=>K[M.currentMapId]),f=F(()=>{var l;return(l=t.value)==null?void 0:l.locations[M.currentLocationId]}),r=F(()=>{var g,u,$;return((($=(u=(g=f.value)==null?void 0:g.npc)==null?void 0:u.shop)==null?void 0:$.items)||[]).map(T=>{const q=me.potions[T.id];return{...T,name:q.name,description:q.description,effect:q.effect}})}),a=F(()=>{const g=(M.player.materials||[]).reduce((u,$)=>(u[$]=(u[$]||0)+1,u),{});return Object.entries(g).map(([u,$])=>{for(const T of Object.values(N.material_types)){const q=T.materials[u];if(q)return{id:u,name:q.name,level:q.level,type:T.name,count:$}}return null}).filter(Boolean)}),v=l=>100*l.level,d=L(!1),x=L(""),y=L("info"),n=L(!1),e=L("确定"),C=L(()=>{}),m=l=>{x.value=`${l.name}<br>${l.description}<br>价格: ${l.price} 金币`,y.value="info",d.value=!0,n.value=!0,e.value="购买",C.value=()=>b(l)},w=l=>{const g=v(l);x.value=`${l.name}<br>类型: ${l.type}<br>等级: ${l.level}<br>售价: ${g} 金币`,y.value="info",d.value=!0,n.value=!0,e.value="出售",C.value=()=>E(l)},b=async l=>{if(M.player.gold<l.price){z(()=>{x.value="金币不足！",y.value="error",n.value=!1,d.value=!0});return}const g={...M.player};g.gold-=l.price,g.potions.push(l.id),await J(g),z(()=>{x.value="购买成功！",y.value="success",n.value=!1,d.value=!0})},E=async l=>{const g=v(l),u={...M.player};u.gold+=g;const $=u.materials.findIndex(T=>T===l.id);$!==-1?(u.materials.splice($,1),await J(u),z(()=>{x.value=`出售成功！获得 ${g} 金币`,y.value="success",n.value=!1,d.value=!0})):z(()=>{x.value="出售失败！",y.value="error",n.value=!1,d.value=!0})},P=()=>{C.value()},V=()=>{s("close")};return(l,g)=>(p(),_("div",Pe,[o("div",{class:"shop-header"},[g[1]||(g[1]=o("div",{class:"title"},"商店",-1)),o("div",{class:"close-button",onClick:V},"×")]),o("div",Oe,[o("div",Ve,[o("div",Be,[(p(!0),_(D,null,Y(r.value,u=>(p(),_("div",{key:u.id,class:"shop-item",onClick:$=>m(u)},[o("div",Ae,R(u.name),1),o("div",We,R(u.price)+" 金币",1)],8,Fe))),128))])]),o("div",De,[o("div",Ye,[(p(!0),_(D,null,Y(a.value,u=>(p(),_("div",{key:u.id,class:"inventory-item",onClick:$=>w(u)},[o("div",He,R(u.name),1),o("div",ze,R(v(u))+" 金币",1),u.count>1?(p(),_("div",Ue,"x"+R(u.count),1)):S("",!0)],8,Xe))),128))])])]),ee(te,{visible:d.value,"onUpdate:visible":g[0]||(g[0]=u=>d.value=u),content:x.value,type:y.value,"show-button":n.value,"button-text":e.value,onAction:P},null,8,["visible","content","type","show-button","button-text"])]))}},Ge=G(Ke,[["__scopeId","data-v-aac1376a"]]),Je={class:"location-container"},Qe={class:"content-wrapper"},Ze={class:"location-header"},et={class:"location-title"},tt={class:"combat-log"},st={class:"combat-log-content"},nt={key:0,class:"tab-container"},at={key:1,class:"enemies-list"},ot={key:0,class:"enemies-list-content"},it=["onClick"],lt=["onClick","disabled"],ct={key:1,class:"empty-enemies"},rt={key:2,class:"npcs-list"},ut={class:"npcs-list-content"},dt=["onClick"],vt={key:0,class:"enter-button"},mt={__name:"LocationView",emits:["close"],setup(k,{emit:i}){const s=L("enemies"),t=L([]);ie();const f=F(()=>K[M.currentMapId].locations[M.currentLocationId]),r=L([]),a=L(!1),v=()=>{const c=M.enemyStatus[M.currentLocationId]||{},h=f.value.enemy||{},I=Object.entries(c).filter(([O,W])=>{const X=W.enemyId,H=h[X];return H?Math.random()<H.probability:!1}).map(([O,W])=>({instanceId:O,name:le.creatures[W.enemyId].name,enemy:W})),B=Math.min(5,I.length);t.value=I.sort(()=>Math.random()-.5).slice(0,B)},d=i;ae(()=>{r.value.push({id:Date.now(),message:`${f.value.description||""}`}),u(),v()});const x=()=>{d("close")},y=c=>({forge:"锻造所",shop:"商店"})[c]||c,n=L(!1),e=L(!1),C=c=>{c==="forge"?n.value=!0:c==="shop"&&(e.value=!0)},m=()=>{n.value=!1},w=()=>{e.value=!1},b=(c,j=500)=>new Promise(h=>{setTimeout(()=>{r.value.push({id:Date.now(),message:c}),h()},j)}),E=async c=>{var j;if(!a.value){a.value=!0;try{const h=await re(c.instanceId);if(!h.player.hit)await b(`你的攻击未命中${c.name}`);else{let I=`你对${c.name}造成了${h.player.damage}点伤害`;if(h.player.isCrit&&(I+="（暴击！）"),await b(I),!((j=M.enemyStatus[M.currentLocationId])!=null&&j[c.instanceId])){if(await b(`${c.name}被击败了！`),h.droppedItems&&h.droppedItems.length>0){const B=h.droppedItems.map(O=>{for(const W in N.material_types){const X=N.material_types[W];if(X.materials[O])return X.materials[O].name}return O}).join("、");await b(`获得了：${B}`)}v();return}}if(h.enemy)if(!h.enemy.hit)await b(`${c.name}的反击未命中你`);else{let I=`${c.name}反击对你造成了${h.enemy.damage}点伤害`;if(h.enemy.isCrit&&(I+="（暴击！）"),await b(I),!h.enemy.isPlayerAlive){await b("你被击败了，装备材料掉了一地，太可惜了");return}}}catch(h){console.error("Attack failed:",h),await b("你脚下一滑，攻击没有发起")}finally{a.value=!1}}};Z(r,()=>{z(()=>{const c=document.querySelector(".combat-log-content");c&&(c.scrollTop=c.scrollHeight)})},{deep:!0});const V=F(()=>t.value.length>0),l=F(()=>f.value.enemy&&Object.keys(f.value.enemy).length>0),g=F(()=>f.value.npc&&Object.keys(f.value.npc).length>0),u=()=>{s.value==="enemies"&&!l.value?s.value=g.value?"npcs":null:s.value==="npcs"&&!g.value&&(s.value=l.value?"enemies":null)},$=L(!1),T=L(""),q=c=>{const j=c.enemy.enemyId,h=ce(j);let I=`${c.name}<br>`;for(const[B,O]of Object.entries(h))I+=`${A.combat_stats[B]}: ${O}<br>`;T.value=I.trim(),$.value=!0};return(c,j)=>(p(),_("div",null,[o("div",{class:"overlay",onClick:x}),o("div",Je,[o("div",Qe,[o("div",Ze,[o("div",et,R(f.value.name),1)]),o("div",tt,[j[3]||(j[3]=o("div",{class:"section-title"},"探索日志",-1)),o("div",st,[(p(!0),_(D,null,Y(r.value,h=>(p(),_("div",{key:h.id},R(h.message),1))),128))])]),l.value||g.value?(p(),_("div",nt,[l.value?(p(),_("div",{key:0,class:U(["tab-item",{active:s.value==="enemies"}]),onClick:j[0]||(j[0]=h=>s.value="enemies")}," 生物列表 ",2)):S("",!0),g.value?(p(),_("div",{key:1,class:U(["tab-item",{active:s.value==="npcs"}]),onClick:j[1]||(j[1]=h=>s.value="npcs")}," NPC列表 ",2)):S("",!0)])):S("",!0),s.value==="enemies"?(p(),_("div",at,[V.value?(p(),_("div",ot,[(p(!0),_(D,null,Y(t.value,h=>(p(),_("div",{key:h.instanceId,class:"enemy-item",onClick:I=>q(h)},[o("span",null,R(h.name)+" (HP: "+R(h.enemy.hp)+")",1),o("button",{onClick:ne(I=>E(h),["stop"]),disabled:a.value}," 攻击 ",8,lt)],8,it))),128))])):(p(),_("div",ct,[o("span",{class:"explore-button",onClick:v}," 继续探索 ")]))])):S("",!0),s.value==="npcs"&&f.value.npc&&g.value?(p(),_("div",rt,[o("div",ut,[(p(!0),_(D,null,Y(f.value.npc,(h,I)=>(p(),_("div",{key:I,class:"npc-item",onClick:B=>C(I)},[o("span",null,R(y(I)),1),I==="forge"||I==="shop"?(p(),_("button",vt,"进入")):S("",!0)],8,dt))),128))])])):S("",!0)])]),n.value?(p(),Q(Ne,{key:0,class:"npc-view",onClose:m})):S("",!0),e.value?(p(),Q(Ge,{key:1,class:"npc-view",onClose:w})):S("",!0),ee(te,{visible:$.value,"onUpdate:visible":j[2]||(j[2]=h=>$.value=h),content:T.value,type:"info","show-button":!1},null,8,["visible","content"])]))}},pt=G(mt,[["__scopeId","data-v-79b18b78"]]),ft=async k=>{const i=M.currentLocationId;if(i===k)return;const s=K[M.currentMapId].locations[i],t=K[M.currentMapId].locations[k];if(!s||!t)return Promise.reject(new Error("无效的位置ID"));if(!s.adjacent_locations.includes(Number(k)))return Promise.reject(new Error(`无法移动到${t.name}，该位置与当前位置不相邻`));const f=Math.sqrt(Math.pow(t.position.x-s.position.x,2)+Math.pow(t.position.y-s.position.y,2)),r=Math.floor(f/50*1e3);await new Promise(a=>{setTimeout(()=>{a()},r)}),ue({currentLocationId:k})},ht={__name:"MapView",setup(k){const i=L(null),s=L(!1),t=K[M.currentMapId],f=t.locations,r=L(!1),a=L(""),v=(n,e,C,m,w,b,E,P,V)=>{const l=Math.atan2(m-e,C-n),g=w+E/2,u=b+P/2,$=E/2,T=P/2;let q,c;return Math.abs(Math.tan(l))*$<=T?(q=Math.cos(l)>0?w+E:w,c=u+Math.tan(l)*(q-g)):(c=Math.sin(l)>0?b+P:b,q=g+(c-u)/Math.tan(l)),{x:q,y:c}},d=()=>{const n=i.value,e=n.getContext("2d");e.clearRect(0,0,n.width,n.height),e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,n.width,n.height);const C=new Set;Object.values(f).forEach(m=>{const w=m.position.x,b=m.position.y;e.font="16px Arial",e.textAlign="center";const E=m.name||"未命名",P=e.measureText(E).width,V=10,l=P+V*2,g=30,u=w-l/2,$=b-g/2;m.adjacent_locations.forEach(T=>{const q=[m.id,T].sort().join("-");if(!C.has(q)){const c=f[T];if(c){const j=c.name||"未命名",I=e.measureText(j).width+V*2,B=30,O=c.position.x-I/2,W=c.position.y-B/2,X=v(w,b,c.position.x,c.position.y,u,$,l,g),H=v(c.position.x,c.position.y,w,b,O,W,I,B);e.beginPath(),e.moveTo(X.x,X.y),e.lineTo(H.x,H.y),e.strokeStyle="#ffd700",e.lineWidth=2,e.stroke(),C.add(q)}}}),e.beginPath(),e.strokeStyle=M.currentLocationId===m.id?"#ff4444":"#ffd700",e.lineWidth=2,e.roundRect(u,$,l,g,8),e.stroke(),Number(M.currentLocationId)===Number(m.id)&&(e.save(),e.shadowColor="#ff4444",e.shadowBlur=10,e.shadowOffsetX=0,e.shadowOffsetY=0,e.strokeStyle="#ff4444",e.lineWidth=2,e.roundRect(u,$,l,g,8),e.stroke(),e.restore()),e.fillStyle="white",e.fillText(E,w,b+5)})},x=async n=>{const C=i.value.getBoundingClientRect(),m=n.clientX-C.left,w=n.clientY-C.top;Object.keys(f).forEach(async b=>{const E=f[b],P=E.position.x,V=E.position.y;if(Math.abs(m-P)<20&&Math.abs(w-V)<20)try{r.value=!0,a.value=`正在前往${E.name}...`,await ft(b),r.value=!1,s.value=!0}catch(l){a.value=l.message,setTimeout(()=>{r.value=!1},2e3)}})},y=()=>{const e=i.value.parentElement,C=f[M.currentLocationId];if(C){const m=C.position.x,w=C.position.y,b=m-e.clientWidth/2,E=w-e.clientHeight/2;e.scrollTo({left:b,top:E,behavior:"smooth"})}};return ae(()=>{const n=i.value;n.width=t.width,n.height=t.height,d(),n.addEventListener("click",x),y()}),Z(()=>M.currentLocationId,d),(n,e)=>(p(),_("div",{class:"map-container",style:de({backgroundImage:`url(${ve(t).bg_image})`})},[o("canvas",{ref_key:"mapCanvas",ref:i,class:"map-canvas"},null,512),s.value?(p(),Q(pt,{key:0,onClose:e[0]||(e[0]=C=>s.value=!1)})):S("",!0),o("button",{class:"focus-button",onClick:y},e[2]||(e[2]=[o("span",{class:"focus-icon"},"📍",-1)])),ee(te,{visible:r.value,"onUpdate:visible":e[1]||(e[1]=C=>r.value=C),content:a.value,type:"info","show-button":!1,"allow-close":!1},null,8,["visible","content"])],4))}},bt=G(ht,[["__scopeId","data-v-4ea0c04e"]]);export{bt as default};
