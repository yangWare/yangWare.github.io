import{s as M,u as z,_ as U,c as b,o as _,a as o,b as S,w as se,F as B,r as O,n as Y,t as T,d as le,e as I,f as P,g as H,h as G,i as D,j as ne,k as K,l as ie,m as ce,p as re}from"./main-CR2e-UWp.js";import{i as V,m as X,M as J,g as ee,e as ue,a as de,b as ve}from"./Message-CQEa4gTx.js";import{m as N,p as me}from"./potion_config-ULSA02dc.js";const pe=(k,l,s=0)=>{const e=k-l;let w;e<-3?w=0:e>6?w=2:w=(e+3)/4.5;const d=l-s;let i;return d<-3?i=0:d>3?i=1:i=(d+3)/6,Math.min(Math.max(.5*w*i,0),1)},fe=(k,l,s)=>{const e=Object.keys(V.equipment_levels),w=Math.random();let d=0;for(const i of e){let m=V.equipment_levels[i].chance;if(s<.7){if(["epic","legendary","mythic"].includes(i)&&Math.random()>.5)return"rare"}else if(s<.8){if(["legendary","mythic"].includes(i)&&Math.random()>.5)return"epic"}else if(s<.9&&i==="mythic"&&Math.random()>.5)return"legendary";if(d+=m,w<=d)return i}return"common"},he=(k,l,s)=>{const e=V.equipment_position[k],d=V.equipment_levels[s].name,i=l.reduce((m,$)=>$.materialLevel>m.materialLevel?$:m);let g="未知";for(const m in N.material_types){const $=N.material_types[m].materials;if($[i.materialId]){g=$[i.materialId].name;break}}return`${d}${g}${e.name}`},ge=(k,l,s,e)=>{for(const w in N.material_types){const d=N.material_types[w],i=d.materials;if(i[k]){const g=i[k],m={},p=V.equipment_position[s].stat_multipliers||{};for(const a in d.base_stats){let t=Math.ceil(d.base_stats[a]*g.multiplier*g.level*l*2*(p[a]||1));if(!["crit_rate","crit_resist","hit_rate","dodge_rate"].includes(a)){const C=V.equipment_levels[e].multiplier;t=Math.ceil(t*C)}m[a]=t}return m}}return null},te=async k=>{const l=[...M.player.materials];k.forEach(s=>{const e=l.indexOf(s);e!==-1&&l.splice(e,1)}),await z({materials:l})},_e=async({materials:k,forgerLevel:l,toolLevel:s,equipmentType:e})=>{if(!k||k.length===0||k.length>5)return{success:!1,message:"材料数量必须在1-5之间"};if(!V.equipment_position[e])return{success:!1,message:"无效的装备类型"};const d=k.map(p=>{let a=0;for(const C in N.material_types){const f=N.material_types[C].materials;if(f[p]){a=f[p].level;break}}const t=pe(l,s,a);return{materialId:p,success:Math.random()<t,successRate:t,materialLevel:a}}).filter(p=>p.success);if(d.length===0)return await te(k),{success:!1,message:"锻造失败，所有材料都未能成功融合"};const i=d.reduce((p,a)=>a.materialLevel>p.materialLevel?a:p),g=fe(l,s,i.successRate),m={type:e,position:e,level:g,combat_info:{}},$=new Set;for(const p in N.material_types){const a=N.material_types[p].base_stats;for(const t in a)$.add(t)}return $.forEach(p=>{m.combat_info[p]=0}),d.forEach(p=>{const a=ge(p.materialId,p.successRate,e,g);a&&Object.keys(a).forEach(t=>{m.combat_info[t]+=a[t]})}),m.name=he(e,d,g),M.player.unequipped.push(m),await te(k),{success:!0,message:`锻造成功！${d.length}个材料成功融合`,equipment:m}},ye={name:"ForgeView",emits:["close"],setup(k,{emit:l}){const s=I([]),e=I(""),w=I(null),d=I(!1),i=V.equipment_position,g=P(()=>M.player.materials);H(g,()=>{s.value=[],e.value=""});const m=f=>{for(const h in N.material_types){const x=N.material_types[h].materials;if(x[f])return x[f].name}return f},$=(f,h)=>{s.value.findIndex(E=>E.index===h)!==-1?p(h):s.value.length<5&&s.value.push({material:f,index:h})},p=f=>{s.value=s.value.filter(h=>h.index!==f)};return{availableMaterials:g,selectedMaterials:s,selectedType:e,equipmentTypes:i,forgeResult:w,getMaterialName:m,toggleMaterial:$,removeMaterial:p,selectEquipmentType:f=>{e.value=f},startForge:async()=>{if(!(!e.value||s.value.length===0||s.value.length>5||d.value)){d.value=!0;try{const f=M.player.forgerLevel||1,h=M.player.toolLevel||1,x=await _e({materials:s.value.map(E=>E.material),forgerLevel:f,toolLevel:h,equipmentType:e.value});w.value=x,s.value=[],e.value=""}finally{d.value=!1}}},handleCloseClick:f=>{const h=f.currentTarget.getBoundingClientRect();f.clientY-h.top<100&&l("close")}}}},be={class:"forge-view-container"},we={class:"forge-view"},ke={class:"forge-header"},Ce={class:"equipment-type-selection"},Me={class:"equipment-types"},$e=["onClick"],xe={class:"materials-selection"},Ie={class:"materials-list"},Le=["onClick"],Ee={key:0,class:"selected-materials"},je={class:"selected-list"},qe=["onClick"],Te=["disabled"],Re={key:0,class:"equipment-stats"};function Se(k,l,s,e,w,d){return _(),b("div",be,[o("div",we,[o("div",ke,[l[2]||(l[2]=o("div",{class:"forge-title"},"装备锻造",-1)),o("button",{class:"close-button",onClick:l[0]||(l[0]=se((...i)=>e.handleCloseClick&&e.handleCloseClick(...i),["stop"]))},"×")]),o("div",Ce,[l[3]||(l[3]=o("div",{class:"section-title"},"选择装备类型",-1)),o("div",Me,[(_(!0),b(B,null,O(e.equipmentTypes,(i,g)=>(_(),b("div",{key:g,class:Y(["equipment-type-item",{selected:e.selectedType===g}]),onClick:m=>e.selectEquipmentType(g)},T(i.name),11,$e))),128))])]),o("div",xe,[l[4]||(l[4]=o("div",{class:"section-title"},"选择材料 (1-5件)",-1)),o("div",Ie,[(_(!0),b(B,null,O(e.availableMaterials,(i,g)=>(_(),b("div",{key:g,class:Y(["material-item",{selected:e.selectedMaterials.some(m=>m.index===g)}]),onClick:m=>e.toggleMaterial(i,g)},T(e.getMaterialName(i)),11,Le))),128))])]),e.selectedMaterials.length>0?(_(),b("div",Ee,[l[5]||(l[5]=o("div",{class:"section-title"},"已选材料",-1)),o("div",je,[(_(!0),b(B,null,O(e.selectedMaterials,(i,g)=>(_(),b("div",{key:g,class:"selected-item"},[le(T(e.getMaterialName(i.material))+" ",1),o("button",{onClick:m=>e.removeMaterial(i.index)},"移除",8,qe)]))),128))])])):S("",!0),o("button",{class:"forge-button",onClick:l[1]||(l[1]=(...i)=>e.startForge&&e.startForge(...i)),disabled:e.selectedMaterials.length===0||e.selectedMaterials.length>5}," 开始锻造 ",8,Te),e.forgeResult?(_(),b("div",{key:1,class:Y(["forge-result",e.forgeResult.success?"success":"fail"])},[l[6]||(l[6]=o("div",{class:"section-title"},"锻造结果",-1)),o("p",null,T(e.forgeResult.message),1),e.forgeResult.equipment?(_(),b("div",Re,[o("p",null,"获得装备："+T(e.forgeResult.equipment.name),1)])):S("",!0)],2)):S("",!0)])])}const Ne=U(ye,[["render",Se],["__scopeId","data-v-143880b7"]]),Pe={class:"shop-view-container"},Ve={class:"shop-content"},Be={class:"shop-section"},Oe={class:"shop-grid"},Fe=["onClick"],Ae={class:"item-name"},We={class:"item-price"},De={class:"inventory-section"},Ye={class:"inventory-grid"},Xe=["onClick"],He={class:"item-name"},Ue={class:"item-price"},ze={key:0,class:"item-count"},Ke={__name:"ShopView",emits:["close"],setup(k,{emit:l}){const s=l,e=P(()=>X[M.currentMapId]),w=P(()=>{var c;return(c=e.value)==null?void 0:c.locations[M.currentLocationId]}),d=P(()=>{var y,v,L;return(((L=(v=(y=w.value)==null?void 0:y.npc)==null?void 0:v.shop)==null?void 0:L.items)||[]).map(u=>{const n=me.potions[u.id];return{...u,name:n.name,description:n.description,effect:n.effect}})}),i=P(()=>{const y=(M.player.materials||[]).reduce((v,L)=>(v[L]=(v[L]||0)+1,v),{});return Object.entries(y).map(([v,L])=>{for(const u of Object.values(N.material_types)){const n=u.materials[v];if(n)return{id:v,name:n.name,level:n.level,type:u.name,count:L}}return null}).filter(Boolean)}),g=c=>100*c.level,m=I(!1),$=I(""),p=I("info"),a=I(!1),t=I("确定"),C=I(()=>{}),f=c=>{$.value=`${c.name}<br>${c.description}<br>价格: ${c.price} 金币`,p.value="info",m.value=!0,a.value=!0,t.value="购买",C.value=()=>x(c)},h=c=>{const y=g(c);$.value=`${c.name}<br>类型: ${c.type}<br>等级: ${c.level}<br>售价: ${y} 金币`,p.value="info",m.value=!0,a.value=!0,t.value="出售",C.value=()=>E(c)},x=async c=>{if(M.player.gold<c.price){D(()=>{$.value="金币不足！",p.value="error",a.value=!1,m.value=!0});return}const y={...M.player};y.gold-=c.price,y.potions.push(c.id),await z(y),D(()=>{$.value="购买成功！",p.value="success",a.value=!1,m.value=!0})},E=async c=>{const y=g(c),v={...M.player};v.gold+=y;const L=v.materials.findIndex(u=>u===c.id);L!==-1?(v.materials.splice(L,1),await z(v),D(()=>{$.value=`出售成功！获得 ${y} 金币`,p.value="success",a.value=!1,m.value=!0})):D(()=>{$.value="出售失败！",p.value="error",a.value=!1,m.value=!0})},q=()=>{C.value()},R=()=>{s("close")};return(c,y)=>(_(),b("div",Pe,[o("div",{class:"shop-header"},[y[1]||(y[1]=o("div",{class:"title"},"商店",-1)),o("div",{class:"close-button",onClick:R},"×")]),o("div",Ve,[o("div",Be,[o("div",Oe,[(_(!0),b(B,null,O(d.value,v=>(_(),b("div",{key:v.id,class:"shop-item",onClick:L=>f(v)},[o("div",Ae,T(v.name),1),o("div",We,T(v.price)+" 金币",1)],8,Fe))),128))])]),o("div",De,[o("div",Ye,[(_(!0),b(B,null,O(i.value,v=>(_(),b("div",{key:v.id,class:"inventory-item",onClick:L=>h(v)},[o("div",He,T(v.name),1),o("div",Ue,T(g(v))+" 金币",1),v.count>1?(_(),b("div",ze,"x"+T(v.count),1)):S("",!0)],8,Xe))),128))])])]),G(J,{visible:m.value,"onUpdate:visible":y[0]||(y[0]=v=>m.value=v),content:$.value,type:p.value,"show-button":a.value,"button-text":t.value,onAction:q},null,8,["visible","content","type","show-button","button-text"])]))}},Ge=U(Ke,[["__scopeId","data-v-aac1376a"]]),Je={class:"location-container"},Qe={class:"content-wrapper"},Ze={class:"location-header"},et={class:"location-title"},tt={class:"combat-log"},st={class:"combat-log-content"},nt={key:0,class:"tab-container"},at={key:1,class:"enemies-list"},ot={class:"enemies-list-content"},lt=["onClick"],it=["onClick","disabled"],ct={key:2,class:"npcs-list"},rt={class:"npcs-list-content"},ut=["onClick"],dt={key:0,class:"enter-button"},vt={__name:"LocationView",emits:["close"],setup(k,{emit:l}){const s=I("enemies");ee();const e=P(()=>X[M.currentMapId].locations[M.currentLocationId]),w=I([]),d=I(!1),i=P(()=>Object.entries(M.enemyStatus).filter(([u,n])=>n.locationId===M.currentLocationId).map(([u,n])=>{const r=n.enemyId,j=ue.creatures[r];return{instanceId:u,creatureId:r,name:j.name,desc:j.desc,hp:n.hp}})),g=l;ne(()=>{w.value.push({id:Date.now(),message:`${e.value.description||""}`}),c()});const m=()=>{g("close")},$=u=>({forge:"锻造所",shop:"商店"})[u]||u,p=I(!1),a=I(!1),t=u=>{u==="forge"?p.value=!0:u==="shop"&&(a.value=!0)},C=()=>{p.value=!1},f=()=>{a.value=!1},h=(u,n=500)=>new Promise(r=>{setTimeout(()=>{w.value.push({id:Date.now(),message:u}),r()},n)}),x=async u=>{if(!d.value){d.value=!0;try{const n=await ve(u.instanceId);if(!n.player.hit)await h(`你的攻击未命中${u.name}`);else{let r=`你对${u.name}造成了${n.player.damage}点伤害`;if(n.player.isCrit&&(r+="（暴击！）"),await h(r),!M.enemyStatus[u.instanceId]){if(await h(`${u.name}被击败了！`),n.drops&&n.drops.length>0){const j=n.drops.map(F=>{for(const A in N.material_types){const W=N.material_types[A];if(W.materials[F])return W.materials[F].name}return F}).join("、");await h(`获得了：${j}`)}ee();return}}if(n.enemy)if(!n.enemy.hit)await h(`${u.name}的反击未命中你`);else{let r=`${u.name}反击对你造成了${n.enemy.damage}点伤害`;if(n.enemy.isCrit&&(r+="（暴击！）"),await h(r),!n.enemy.isPlayerAlive){await h("你被击败了，装备材料掉了一地，太可惜了");return}}}catch(n){console.error("Attack failed:",n),await h("你脚下一滑，攻击没有发起")}finally{d.value=!1}}};H(w,()=>{D(()=>{const u=document.querySelector(".combat-log-content");u&&(u.scrollTop=u.scrollHeight)})},{deep:!0});const q=P(()=>i.value.length>0),R=P(()=>e.value.npc&&Object.keys(e.value.npc).length>0),c=()=>{s.value==="enemies"&&!q.value?s.value=R.value?"npcs":null:s.value==="npcs"&&!R.value&&(s.value=q.value?"enemies":null)};H([q,R],()=>{c()});const y=I(!1),v=I(""),L=u=>{const n=u.creatureId,r=de(n);let j=`${u.name}<br>`;for(const[F,A]of Object.entries(r))j+=`${V.combat_stats[F]}: ${A}<br>`;v.value=j.trim(),y.value=!0};return(u,n)=>(_(),b("div",null,[o("div",{class:"overlay",onClick:m}),o("div",Je,[o("div",Qe,[o("div",Ze,[o("div",et,T(e.value.name),1)]),o("div",tt,[n[3]||(n[3]=o("div",{class:"section-title"},"探索日志",-1)),o("div",st,[(_(!0),b(B,null,O(w.value,r=>(_(),b("div",{key:r.id},T(r.message),1))),128))])]),q.value||R.value?(_(),b("div",nt,[q.value?(_(),b("div",{key:0,class:Y(["tab-item",{active:s.value==="enemies"}]),onClick:n[0]||(n[0]=r=>s.value="enemies")}," 生物列表 ",2)):S("",!0),R.value?(_(),b("div",{key:1,class:Y(["tab-item",{active:s.value==="npcs"}]),onClick:n[1]||(n[1]=r=>s.value="npcs")}," NPC列表 ",2)):S("",!0)])):S("",!0),s.value==="enemies"&&q.value?(_(),b("div",at,[o("div",ot,[(_(!0),b(B,null,O(i.value,r=>(_(),b("div",{key:r.instanceId,class:"enemy-item",onClick:j=>L(r)},[o("span",null,T(r.name)+" (HP: "+T(r.hp)+")",1),o("button",{onClick:se(j=>x(r),["stop"]),disabled:d.value}," 攻击 ",8,it)],8,lt))),128))])])):S("",!0),s.value==="npcs"&&e.value.npc&&R.value?(_(),b("div",ct,[o("div",rt,[(_(!0),b(B,null,O(e.value.npc,(r,j)=>(_(),b("div",{key:j,class:"npc-item",onClick:F=>t(j)},[o("span",null,T($(j)),1),j==="forge"||j==="shop"?(_(),b("button",dt,"进入")):S("",!0)],8,ut))),128))])])):S("",!0)])]),p.value?(_(),K(Ne,{key:0,class:"npc-view",onClose:C})):S("",!0),a.value?(_(),K(Ge,{key:1,class:"npc-view",onClose:f})):S("",!0),G(J,{visible:y.value,"onUpdate:visible":n[2]||(n[2]=r=>y.value=r),content:v.value,type:"info","show-button":!1},null,8,["visible","content"])]))}},mt=U(vt,[["__scopeId","data-v-599a5b09"]]),pt=async k=>{const l=M.currentLocationId;if(l===k)return;const s=X[M.currentMapId].locations[l],e=X[M.currentMapId].locations[k];if(!s||!e)return Promise.reject(new Error("无效的位置ID"));if(!s.adjacent_locations.includes(Number(k)))return Promise.reject(new Error(`无法移动到${e.name}，该位置与当前位置不相邻`));const w=Math.sqrt(Math.pow(e.position.x-s.position.x,2)+Math.pow(e.position.y-s.position.y,2)),d=Math.floor(w/50*1e3);await new Promise(i=>{setTimeout(()=>{i()},d)}),ie({currentLocationId:k})},ft={__name:"MapView",setup(k){const l=I(null),s=I(!1),e=X[M.currentMapId],w=e.locations,d=I(!1),i=I(""),g=(a,t,C,f,h,x,E,q,R)=>{const c=Math.atan2(f-t,C-a),y=h+E/2,v=x+q/2,L=E/2,u=q/2;let n,r;return Math.abs(Math.tan(c))*L<=u?(n=Math.cos(c)>0?h+E:h,r=v+Math.tan(c)*(n-y)):(r=Math.sin(c)>0?x+q:x,n=y+(r-v)/Math.tan(c)),{x:n,y:r}},m=()=>{const a=l.value,t=a.getContext("2d");t.clearRect(0,0,a.width,a.height),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,a.width,a.height);const C=new Set;Object.values(w).forEach(f=>{const h=f.position.x,x=f.position.y;t.font="16px Arial",t.textAlign="center";const E=f.name||"未命名",q=t.measureText(E).width,R=10,c=q+R*2,y=30,v=h-c/2,L=x-y/2;f.adjacent_locations.forEach(u=>{const n=[f.id,u].sort().join("-");if(!C.has(n)){const r=w[u];if(r){const j=r.name||"未命名",A=t.measureText(j).width+R*2,W=30,ae=r.position.x-A/2,oe=r.position.y-W/2,Q=g(h,x,r.position.x,r.position.y,v,L,c,y),Z=g(r.position.x,r.position.y,h,x,ae,oe,A,W);t.beginPath(),t.moveTo(Q.x,Q.y),t.lineTo(Z.x,Z.y),t.strokeStyle="#ffd700",t.lineWidth=2,t.stroke(),C.add(n)}}}),t.beginPath(),t.strokeStyle=M.currentLocationId===f.id?"#ff4444":"#ffd700",t.lineWidth=2,t.roundRect(v,L,c,y,8),t.stroke(),Number(M.currentLocationId)===Number(f.id)&&(t.save(),t.shadowColor="#ff4444",t.shadowBlur=10,t.shadowOffsetX=0,t.shadowOffsetY=0,t.strokeStyle="#ff4444",t.lineWidth=2,t.roundRect(v,L,c,y,8),t.stroke(),t.restore()),t.fillStyle="white",t.fillText(E,h,x+5)})},$=async a=>{const C=l.value.getBoundingClientRect(),f=a.clientX-C.left,h=a.clientY-C.top;Object.keys(w).forEach(async x=>{const E=w[x],q=E.position.x,R=E.position.y;if(Math.abs(f-q)<20&&Math.abs(h-R)<20)try{d.value=!0,i.value=`正在前往${E.name}...`,await pt(x),d.value=!1,s.value=!0}catch(c){i.value=c.message,setTimeout(()=>{d.value=!1},2e3)}})},p=()=>{const t=l.value.parentElement,C=w[M.currentLocationId];if(C){const f=C.position.x,h=C.position.y,x=f-t.clientWidth/2,E=h-t.clientHeight/2;t.scrollTo({left:x,top:E,behavior:"smooth"})}};return ne(()=>{const a=l.value;a.width=e.width,a.height=e.height,m(),a.addEventListener("click",$),p()}),H(()=>M.currentLocationId,m),(a,t)=>(_(),b("div",{class:"map-container",style:ce({backgroundImage:`url(${re(e).bg_image})`})},[o("canvas",{ref_key:"mapCanvas",ref:l,class:"map-canvas"},null,512),s.value?(_(),K(mt,{key:0,onClose:t[0]||(t[0]=C=>s.value=!1)})):S("",!0),o("button",{class:"focus-button",onClick:p},t[2]||(t[2]=[o("span",{class:"focus-icon"},"📍",-1)])),G(J,{visible:d.value,"onUpdate:visible":t[1]||(t[1]=C=>d.value=C),content:i.value,type:"info","show-button":!1,"allow-close":!1},null,8,["visible","content"])],4))}},yt=U(ft,[["__scopeId","data-v-4ea0c04e"]]);export{yt as default};
