import{s as M,u as U,_ as H,c as b,o as y,a,b as S,w as se,F as B,r as O,n as D,t as T,d as ie,e as I,f as P,g as X,h as G,i as z,j as ne,k as K,l as le,m as ce,p as re}from"./main-DFkm9Y6l.js";import{i as V,m as Y,M as J,g as ee,e as ue,a as de,b as ve}from"./Message-D5dYvyB-.js";import{m as N}from"./material_config-Bu-F0gt6.js";const pe=(k,i,s=0)=>{const e=k-i;let w;e<-3?w=0:e>6?w=2:w=(e+3)/4.5;const d=i-s;let l;return d<-3?l=0:d>3?l=1:l=(d+3)/6,Math.min(Math.max(.5*w*l,0),1)},me=(k,i,s)=>{const e=Object.keys(V.equipment_levels),w=Math.random();let d=0;for(const l of e){let h=V.equipment_levels[l].chance;if(s<.7){if(["epic","legendary","mythic"].includes(l)&&Math.random()>.5)return"rare"}else if(s<.8){if(["legendary","mythic"].includes(l)&&Math.random()>.5)return"epic"}else if(s<.9&&l==="mythic"&&Math.random()>.5)return"legendary";if(d+=h,w<=d)return l}return"common"},fe=(k,i,s)=>{const e=V.equipment_position[k],d=V.equipment_levels[s].name,l=i.reduce((h,$)=>$.materialLevel>h.materialLevel?$:h);let _="未知";for(const h in N.material_types){const $=N.material_types[h].materials;if($[l.materialId]){_=$[l.materialId].name;break}}return`${d}${_}${e.name}`},he=(k,i,s,e)=>{for(const w in N.material_types){const d=N.material_types[w],l=d.materials;if(l[k]){const _=l[k],h={},p=V.equipment_position[s].stat_multipliers||{};for(const o in d.base_stats){let t=Math.ceil(d.base_stats[o]*_.multiplier*_.level*i*2*(p[o]||1));if(!["crit_rate","crit_resist","hit_rate","dodge_rate"].includes(o)){const C=V.equipment_levels[e].multiplier;t=Math.ceil(t*C)}h[o]=t}return h}}return null},te=async k=>{const i=[...M.player.materials];k.forEach(s=>{const e=i.indexOf(s);e!==-1&&i.splice(e,1)}),await U({materials:i})},_e=async({materials:k,forgerLevel:i,toolLevel:s,equipmentType:e})=>{if(!k||k.length===0||k.length>5)return{success:!1,message:"材料数量必须在1-5之间"};if(!V.equipment_position[e])return{success:!1,message:"无效的装备类型"};const d=k.map(p=>{let o=0;for(const C in N.material_types){const m=N.material_types[C].materials;if(m[p]){o=m[p].level;break}}const t=pe(i,s,o);return{materialId:p,success:Math.random()<t,successRate:t,materialLevel:o}}).filter(p=>p.success);if(d.length===0)return await te(k),{success:!1,message:"锻造失败，所有材料都未能成功融合"};const l=d.reduce((p,o)=>o.materialLevel>p.materialLevel?o:p),_=me(i,s,l.successRate),h={type:e,position:e,level:_,combat_info:{}},$=new Set;for(const p in N.material_types){const o=N.material_types[p].base_stats;for(const t in o)$.add(t)}return $.forEach(p=>{h.combat_info[p]=0}),d.forEach(p=>{const o=he(p.materialId,p.successRate,e,_);o&&Object.keys(o).forEach(t=>{h.combat_info[t]+=o[t]})}),h.name=fe(e,d,_),M.player.unequipped.push(h),await te(k),{success:!0,message:`锻造成功！${d.length}个材料成功融合`,equipment:h}},ye={name:"ForgeView",emits:["close"],setup(k,{emit:i}){const s=I([]),e=I(""),w=I(null),d=I(!1),l=V.equipment_position,_=P(()=>M.player.materials);X(_,()=>{s.value=[],e.value=""});const h=m=>{for(const f in N.material_types){const x=N.material_types[f].materials;if(x[m])return x[m].name}return m},$=(m,f)=>{s.value.findIndex(E=>E.index===f)!==-1?p(f):s.value.length<5&&s.value.push({material:m,index:f})},p=m=>{s.value=s.value.filter(f=>f.index!==m)};return{availableMaterials:_,selectedMaterials:s,selectedType:e,equipmentTypes:l,forgeResult:w,getMaterialName:h,toggleMaterial:$,removeMaterial:p,selectEquipmentType:m=>{e.value=m},startForge:async()=>{if(!(!e.value||s.value.length===0||s.value.length>5||d.value)){d.value=!0;try{const m=M.player.forgerLevel||1,f=M.player.toolLevel||1,x=await _e({materials:s.value.map(E=>E.material),forgerLevel:m,toolLevel:f,equipmentType:e.value});w.value=x,s.value=[],e.value=""}finally{d.value=!1}}},handleCloseClick:m=>{const f=m.currentTarget.getBoundingClientRect();m.clientY-f.top<100&&i("close")}}}},ge={class:"forge-view-container"},be={class:"forge-view"},we={class:"forge-header"},ke={class:"equipment-type-selection"},Ce={class:"equipment-types"},Me=["onClick"],$e={class:"materials-selection"},xe={class:"materials-list"},Ie=["onClick"],Le={key:0,class:"selected-materials"},Ee={class:"selected-list"},je=["onClick"],qe=["disabled"],Te={key:0,class:"equipment-stats"};function Re(k,i,s,e,w,d){return y(),b("div",ge,[a("div",be,[a("div",we,[i[2]||(i[2]=a("div",{class:"forge-title"},"装备锻造",-1)),a("button",{class:"close-button",onClick:i[0]||(i[0]=se((...l)=>e.handleCloseClick&&e.handleCloseClick(...l),["stop"]))},"×")]),a("div",ke,[i[3]||(i[3]=a("div",{class:"section-title"},"选择装备类型",-1)),a("div",Ce,[(y(!0),b(B,null,O(e.equipmentTypes,(l,_)=>(y(),b("div",{key:_,class:D(["equipment-type-item",{selected:e.selectedType===_}]),onClick:h=>e.selectEquipmentType(_)},T(l.name),11,Me))),128))])]),a("div",$e,[i[4]||(i[4]=a("div",{class:"section-title"},"选择材料 (1-5件)",-1)),a("div",xe,[(y(!0),b(B,null,O(e.availableMaterials,(l,_)=>(y(),b("div",{key:_,class:D(["material-item",{selected:e.selectedMaterials.some(h=>h.index===_)}]),onClick:h=>e.toggleMaterial(l,_)},T(e.getMaterialName(l)),11,Ie))),128))])]),e.selectedMaterials.length>0?(y(),b("div",Le,[i[5]||(i[5]=a("div",{class:"section-title"},"已选材料",-1)),a("div",Ee,[(y(!0),b(B,null,O(e.selectedMaterials,(l,_)=>(y(),b("div",{key:_,class:"selected-item"},[ie(T(e.getMaterialName(l.material))+" ",1),a("button",{onClick:h=>e.removeMaterial(l.index)},"移除",8,je)]))),128))])])):S("",!0),a("button",{class:"forge-button",onClick:i[1]||(i[1]=(...l)=>e.startForge&&e.startForge(...l)),disabled:e.selectedMaterials.length===0||e.selectedMaterials.length>5}," 开始锻造 ",8,qe),e.forgeResult?(y(),b("div",{key:1,class:D(["forge-result",e.forgeResult.success?"success":"fail"])},[i[6]||(i[6]=a("div",{class:"section-title"},"锻造结果",-1)),a("p",null,T(e.forgeResult.message),1),e.forgeResult.equipment?(y(),b("div",Te,[a("p",null,"获得装备："+T(e.forgeResult.equipment.name),1)])):S("",!0)],2)):S("",!0)])])}const Se=H(ye,[["render",Re],["__scopeId","data-v-143880b7"]]),Ne={potion_001:{id:"potion_001",name:"小型生命药水",description:"恢复少量生命值的药水",effect:{type:"hp",value:50}},potion_002:{id:"potion_002",name:"中型生命药水",description:"恢复中等生命值的药水",effect:{type:"hp",value:100}},potion_003:{id:"potion_003",name:"大型生命药水",description:"恢复大量生命值的药水",effect:{type:"hp",value:200}}},Pe={potions:Ne},Ve={class:"shop-view-container"},Be={class:"shop-content"},Oe={class:"shop-section"},Fe={class:"shop-grid"},Ae=["onClick"],We={class:"item-name"},De={class:"item-price"},Ye={class:"inventory-section"},Xe={class:"inventory-grid"},He=["onClick"],Ue={class:"item-name"},ze={class:"item-price"},Ke={key:0,class:"item-count"},Ge={__name:"ShopView",emits:["close"],setup(k,{emit:i}){const s=i,e=P(()=>Y[M.currentMapId]),w=P(()=>{var c;return(c=e.value)==null?void 0:c.locations[M.currentLocationId]}),d=P(()=>{var g,v,L;return(((L=(v=(g=w.value)==null?void 0:g.npc)==null?void 0:v.shop)==null?void 0:L.items)||[]).map(u=>{const n=Pe.potions[u.id];return{...u,name:n.name,description:n.description,effect:n.effect}})}),l=P(()=>{const g=(M.player.materials||[]).reduce((v,L)=>(v[L]=(v[L]||0)+1,v),{});return Object.entries(g).map(([v,L])=>{for(const u of Object.values(N.material_types)){const n=u.materials[v];if(n)return{id:v,name:n.name,level:n.level,type:u.name,count:L}}return null}).filter(Boolean)}),_=c=>100*c.level,h=I(!1),$=I(""),p=I("info"),o=I(!1),t=I("确定"),C=I(()=>{}),m=c=>{$.value=`${c.name}<br>${c.description}<br>价格: ${c.price} 金币`,p.value="info",h.value=!0,o.value=!0,t.value="购买",C.value=()=>x(c)},f=c=>{const g=_(c);$.value=`${c.name}<br>类型: ${c.type}<br>等级: ${c.level}<br>售价: ${g} 金币`,p.value="info",h.value=!0,o.value=!0,t.value="出售",C.value=()=>E(c)},x=async c=>{if(M.player.gold<c.price){z(()=>{$.value="金币不足！",p.value="error",o.value=!1,h.value=!0});return}const g={...M.player};g.gold-=c.price,g.potions.push(c),await U(g),z(()=>{$.value="购买成功！",p.value="success",o.value=!1,h.value=!0})},E=async c=>{const g=_(c),v={...M.player};v.gold+=g;const L=v.materials.findIndex(u=>u===c.id);L!==-1?(v.materials.splice(L,1),await U(v),$.value=`出售成功！获得 ${g} 金币`,p.value="success"):($.value="出售失败！",p.value="error"),o.value=!1},q=()=>{C.value()},R=()=>{s("close")};return(c,g)=>(y(),b("div",Ve,[a("div",{class:"shop-header"},[g[1]||(g[1]=a("div",{class:"title"},"商店",-1)),a("div",{class:"close-button",onClick:R},"×")]),a("div",Be,[a("div",Oe,[a("div",Fe,[(y(!0),b(B,null,O(d.value,v=>(y(),b("div",{key:v.id,class:"shop-item",onClick:L=>m(v)},[a("div",We,T(v.name),1),a("div",De,T(v.price)+" 金币",1)],8,Ae))),128))])]),a("div",Ye,[a("div",Xe,[(y(!0),b(B,null,O(l.value,v=>(y(),b("div",{key:v.id,class:"inventory-item",onClick:L=>f(v)},[a("div",Ue,T(v.name),1),a("div",ze,T(_(v))+" 金币",1),v.count>1?(y(),b("div",Ke,"x"+T(v.count),1)):S("",!0)],8,He))),128))])])]),G(J,{visible:h.value,"onUpdate:visible":g[0]||(g[0]=v=>h.value=v),content:$.value,type:p.value,"show-button":o.value,"button-text":t.value,onAction:q},null,8,["visible","content","type","show-button","button-text"])]))}},Je=H(Ge,[["__scopeId","data-v-fe2b6861"]]),Qe={class:"location-container"},Ze={class:"content-wrapper"},et={class:"location-header"},tt={class:"location-title"},st={class:"combat-log"},nt={class:"combat-log-content"},ot={key:0,class:"tab-container"},at={key:1,class:"enemies-list"},it={class:"enemies-list-content"},lt=["onClick"],ct=["onClick","disabled"],rt={key:2,class:"npcs-list"},ut={class:"npcs-list-content"},dt=["onClick"],vt={key:0,class:"enter-button"},pt={__name:"LocationView",emits:["close"],setup(k,{emit:i}){const s=I("enemies");ee();const e=P(()=>Y[M.currentMapId].locations[M.currentLocationId]),w=I([]),d=I(!1),l=P(()=>Object.entries(M.enemyStatus).filter(([u,n])=>n.locationId===M.currentLocationId).map(([u,n])=>{const r=n.enemyId,j=ue.creatures[r];return{instanceId:u,creatureId:r,name:j.name,desc:j.desc,hp:n.hp}})),_=i;ne(()=>{w.value.push({id:Date.now(),message:`${e.value.description||""}`}),c()});const h=()=>{_("close")},$=u=>({forge:"锻造所",shop:"商店"})[u]||u,p=I(!1),o=I(!1),t=u=>{u==="forge"?p.value=!0:u==="shop"&&(o.value=!0)},C=()=>{p.value=!1},m=()=>{o.value=!1},f=(u,n=500)=>new Promise(r=>{setTimeout(()=>{w.value.push({id:Date.now(),message:u}),r()},n)}),x=async u=>{if(!d.value){d.value=!0;try{const n=await ve(u.instanceId);if(!n.player.hit)await f(`你的攻击未命中${u.name}`);else{let r=`你对${u.name}造成了${n.player.damage}点伤害`;if(n.player.isCrit&&(r+="（暴击！）"),await f(r),!M.enemyStatus[u.instanceId]){if(await f(`${u.name}被击败了！`),n.drops&&n.drops.length>0){const j=n.drops.map(F=>{for(const A in N.material_types){const W=N.material_types[A];if(W.materials[F])return W.materials[F].name}return F}).join("、");await f(`获得了：${j}`)}ee();return}}if(n.enemy)if(!n.enemy.hit)await f(`${u.name}的反击未命中你`);else{let r=`${u.name}反击对你造成了${n.enemy.damage}点伤害`;if(n.enemy.isCrit&&(r+="（暴击！）"),await f(r),!n.enemy.isPlayerAlive){await f("你被击败了，装备材料掉了一地，太可惜了");return}}}catch(n){console.error("Attack failed:",n),await f("你脚下一滑，攻击没有发起")}finally{d.value=!1}}};X(w,()=>{z(()=>{const u=document.querySelector(".combat-log-content");u&&(u.scrollTop=u.scrollHeight)})},{deep:!0});const q=P(()=>l.value.length>0),R=P(()=>e.value.npc&&Object.keys(e.value.npc).length>0),c=()=>{s.value==="enemies"&&!q.value?s.value=R.value?"npcs":null:s.value==="npcs"&&!R.value&&(s.value=q.value?"enemies":null)};X([q,R],()=>{c()});const g=I(!1),v=I(""),L=u=>{const n=u.creatureId,r=de(n);let j=`${u.name}<br>`;for(const[F,A]of Object.entries(r))j+=`${V.combat_stats[F]}: ${A}<br>`;v.value=j.trim(),g.value=!0};return(u,n)=>(y(),b("div",null,[a("div",{class:"overlay",onClick:h}),a("div",Qe,[a("div",Ze,[a("div",et,[a("div",tt,T(e.value.name),1)]),a("div",st,[n[3]||(n[3]=a("div",{class:"section-title"},"探索日志",-1)),a("div",nt,[(y(!0),b(B,null,O(w.value,r=>(y(),b("div",{key:r.id},T(r.message),1))),128))])]),q.value||R.value?(y(),b("div",ot,[q.value?(y(),b("div",{key:0,class:D(["tab-item",{active:s.value==="enemies"}]),onClick:n[0]||(n[0]=r=>s.value="enemies")}," 生物列表 ",2)):S("",!0),R.value?(y(),b("div",{key:1,class:D(["tab-item",{active:s.value==="npcs"}]),onClick:n[1]||(n[1]=r=>s.value="npcs")}," NPC列表 ",2)):S("",!0)])):S("",!0),s.value==="enemies"&&q.value?(y(),b("div",at,[a("div",it,[(y(!0),b(B,null,O(l.value,r=>(y(),b("div",{key:r.instanceId,class:"enemy-item",onClick:j=>L(r)},[a("span",null,T(r.name)+" (HP: "+T(r.hp)+")",1),a("button",{onClick:se(j=>x(r),["stop"]),disabled:d.value}," 攻击 ",8,ct)],8,lt))),128))])])):S("",!0),s.value==="npcs"&&e.value.npc&&R.value?(y(),b("div",rt,[a("div",ut,[(y(!0),b(B,null,O(e.value.npc,(r,j)=>(y(),b("div",{key:j,class:"npc-item",onClick:F=>t(j)},[a("span",null,T($(j)),1),j==="forge"||j==="shop"?(y(),b("button",vt,"进入")):S("",!0)],8,dt))),128))])])):S("",!0)])]),p.value?(y(),K(Se,{key:0,class:"npc-view",onClose:C})):S("",!0),o.value?(y(),K(Je,{key:1,class:"npc-view",onClose:m})):S("",!0),G(J,{visible:g.value,"onUpdate:visible":n[2]||(n[2]=r=>g.value=r),content:v.value,type:"info","show-button":!1},null,8,["visible","content"])]))}},mt=H(pt,[["__scopeId","data-v-599a5b09"]]),ft=async k=>{const i=M.currentLocationId;if(i===k)return;const s=Y[M.currentMapId].locations[i],e=Y[M.currentMapId].locations[k];if(!s||!e)return Promise.reject(new Error("无效的位置ID"));if(!s.adjacent_locations.includes(Number(k)))return Promise.reject(new Error(`无法移动到${e.name}，该位置与当前位置不相邻`));const w=Math.sqrt(Math.pow(e.position.x-s.position.x,2)+Math.pow(e.position.y-s.position.y,2)),d=Math.floor(w/50*1e3);await new Promise(l=>{setTimeout(()=>{l()},d)}),le({currentLocationId:k})},ht={__name:"MapView",setup(k){const i=I(null),s=I(!1),e=Y[M.currentMapId],w=e.locations,d=I(!1),l=I(""),_=(o,t,C,m,f,x,E,q,R)=>{const c=Math.atan2(m-t,C-o),g=f+E/2,v=x+q/2,L=E/2,u=q/2;let n,r;return Math.abs(Math.tan(c))*L<=u?(n=Math.cos(c)>0?f+E:f,r=v+Math.tan(c)*(n-g)):(r=Math.sin(c)>0?x+q:x,n=g+(r-v)/Math.tan(c)),{x:n,y:r}},h=()=>{const o=i.value,t=o.getContext("2d");t.clearRect(0,0,o.width,o.height),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,o.width,o.height);const C=new Set;Object.values(w).forEach(m=>{const f=m.position.x,x=m.position.y;t.font="16px Arial",t.textAlign="center";const E=m.name||"未命名",q=t.measureText(E).width,R=10,c=q+R*2,g=30,v=f-c/2,L=x-g/2;m.adjacent_locations.forEach(u=>{const n=[m.id,u].sort().join("-");if(!C.has(n)){const r=w[u];if(r){const j=r.name||"未命名",A=t.measureText(j).width+R*2,W=30,oe=r.position.x-A/2,ae=r.position.y-W/2,Q=_(f,x,r.position.x,r.position.y,v,L,c,g),Z=_(r.position.x,r.position.y,f,x,oe,ae,A,W);t.beginPath(),t.moveTo(Q.x,Q.y),t.lineTo(Z.x,Z.y),t.strokeStyle="#ffd700",t.lineWidth=2,t.stroke(),C.add(n)}}}),t.beginPath(),t.strokeStyle=M.currentLocationId===m.id?"#ff4444":"#ffd700",t.lineWidth=2,t.roundRect(v,L,c,g,8),t.stroke(),Number(M.currentLocationId)===Number(m.id)&&(t.save(),t.shadowColor="#ff4444",t.shadowBlur=10,t.shadowOffsetX=0,t.shadowOffsetY=0,t.strokeStyle="#ff4444",t.lineWidth=2,t.roundRect(v,L,c,g,8),t.stroke(),t.restore()),t.fillStyle="white",t.fillText(E,f,x+5)})},$=async o=>{const C=i.value.getBoundingClientRect(),m=o.clientX-C.left,f=o.clientY-C.top;Object.keys(w).forEach(async x=>{const E=w[x],q=E.position.x,R=E.position.y;if(Math.abs(m-q)<20&&Math.abs(f-R)<20)try{d.value=!0,l.value=`正在前往${E.name}...`,await ft(x),d.value=!1,s.value=!0}catch(c){l.value=c.message,setTimeout(()=>{d.value=!1},2e3)}})},p=()=>{const t=i.value.parentElement,C=w[M.currentLocationId];if(C){const m=C.position.x,f=C.position.y,x=m-t.clientWidth/2,E=f-t.clientHeight/2;t.scrollTo({left:x,top:E,behavior:"smooth"})}};return ne(()=>{const o=i.value;o.width=e.width,o.height=e.height,h(),o.addEventListener("click",$),p()}),X(()=>M.currentLocationId,h),(o,t)=>(y(),b("div",{class:"map-container",style:ce({backgroundImage:`url(${re(e).bg_image})`})},[a("canvas",{ref_key:"mapCanvas",ref:i,class:"map-canvas"},null,512),s.value?(y(),K(mt,{key:0,onClose:t[0]||(t[0]=C=>s.value=!1)})):S("",!0),a("button",{class:"focus-button",onClick:p},t[2]||(t[2]=[a("span",{class:"focus-icon"},"📍",-1)])),G(J,{visible:d.value,"onUpdate:visible":t[1]||(t[1]=C=>d.value=C),content:l.value,type:"info","show-button":!1,"allow-close":!1},null,8,["visible","content"])],4))}},bt=H(ht,[["__scopeId","data-v-4ea0c04e"]]);export{bt as default};
