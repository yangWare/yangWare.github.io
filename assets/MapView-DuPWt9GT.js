import{s as M,u as J,_ as G,c as _,o as p,a as i,b as S,w as ne,F as D,r as Y,n as z,t as R,d as ae,e as L,f as F,g as Z,m as U,h as ee,i as K,j as ie,k as oe,l as Q,p as le,q as ce,v as re,x as ue,y as de,z as ve}from"./main-Ym5FqLnE.js";import{m as N,p as me}from"./potion_config-DhB3lQQX.js";import{i as A,M as te}from"./Message-_jpLZiTK.js";const pe=(k,l,s=0)=>{const t=k-l;let f;t<-3?f=0:t>3?f=2:f=(t+3)/3;const r=l-s;let a;return r<-3?a=0:r>3?a=1:a=(r+3)/6,Math.min(Math.max(.5*f*a,0),1)},fe=(k,l,s)=>{const t=Object.keys(A.equipment_levels),f=Math.random();let r=0,a="common";for(const u of t){const v=A.equipment_levels[u];if(r+=v.chance,f<=r){a=u;break}}if(s<.7){if(["epic","legendary","mythic"].includes(a)&&Math.random()>.5)return"rare"}else if(s<.8){if(["legendary","mythic"].includes(a)&&Math.random()>.5)return"epic"}else if(s<.9&&a==="mythic"&&Math.random()>.5)return"legendary";return a},he=(k,l,s)=>{const t=A.equipment_position[k],r=A.equipment_levels[s].name,a=l.reduce((v,x)=>x.materialLevel>v.materialLevel?x:v);let u="未知";for(const v in N.material_types){const x=N.material_types[v].materials;if(x[a.materialId]){u=x[a.materialId].name;break}}return`${r}${u}${t.name}`},ye=(k,l,s,t)=>{for(const f in N.material_types){const r=N.material_types[f],a=r.materials;if(a[k]){const u=a[k],v={},y=A.equipment_position[s].stat_multipliers||{};for(const n in r.base_stats){let e=Math.ceil(r.base_stats[n]*u.multiplier*u.level*l*2*(y[n]||1));if(!["crit_rate","crit_resist","hit_rate","dodge_rate"].includes(n)){const C=A.equipment_levels[t].multiplier;e=Math.ceil(e*C)}v[n]=e}return v}}return null},se=async k=>{const l=[...M.player.materials];k.forEach(s=>{const t=l.indexOf(s);t!==-1&&l.splice(t,1)}),await J({materials:l})},ge=async({materials:k,forgerLevel:l,toolLevel:s,equipmentType:t})=>{if(!k||k.length===0||k.length>5)return{success:!1,message:"材料数量必须在1-5之间"};if(!A.equipment_position[t])return{success:!1,message:"无效的装备类型"};const r=k.map(y=>{let n=0;for(const C in N.material_types){const m=N.material_types[C].materials;if(m[y]){n=m[y].level;break}}const e=pe(l,s,n);return{materialId:y,success:Math.random()<e,successRate:e,materialLevel:n}}).filter(y=>y.success);if(r.length===0)return await se(k),{success:!1,message:"锻造失败，所有材料都未能成功融合"};const a=r.reduce((y,n)=>n.materialLevel>y.materialLevel?n:y),u=fe(l,s,a.successRate),v={type:t,position:t,level:u,combat_info:{}},x=new Set;for(const y in N.material_types){const n=N.material_types[y].base_stats;for(const e in n)x.add(e)}return x.forEach(y=>{v.combat_info[y]=0}),r.forEach(y=>{const n=ye(y.materialId,y.successRate,t,u);n&&Object.keys(n).forEach(e=>{v.combat_info[e]+=n[e]})}),v.name=he(t,r,u),M.player.unequipped.push(v),await se(k),{success:!0,message:`锻造成功！${r.length}个材料成功融合`,equipment:v}},_e={name:"ForgeView",emits:["close"],setup(k,{emit:l}){const s=L([]),t=L(""),f=L(null),r=L(!1),a=A.equipment_position,u=F(()=>M.player.materials);Z(u,()=>{s.value=[],t.value=""});const v=m=>{for(const w in N.material_types){const b=N.material_types[w].materials;if(b[m])return b[m].name}return m},x=(m,w)=>{s.value.findIndex(E=>E.index===w)!==-1?y(w):s.value.length<5&&s.value.push({material:m,index:w})},y=m=>{s.value=s.value.filter(w=>w.index!==m)};return{availableMaterials:u,selectedMaterials:s,selectedType:t,equipmentTypes:a,forgeResult:f,getMaterialName:v,toggleMaterial:x,removeMaterial:y,selectEquipmentType:m=>{t.value=m},startForge:async()=>{if(!(!t.value||s.value.length===0||s.value.length>5||r.value)){r.value=!0;try{const m=M.player.forgerLevel||1,w=M.player.toolLevel||1,b=await ge({materials:s.value.map(E=>E.material),forgerLevel:m,toolLevel:w,equipmentType:t.value});f.value=b,s.value=[],t.value=""}finally{r.value=!1}}},handleCloseClick:m=>{const w=m.currentTarget.getBoundingClientRect();m.clientY-w.top<100&&l("close")}}}},be={class:"forge-view-container"},we={class:"forge-view"},ke={class:"forge-header"},Ce={class:"equipment-type-selection"},Me={class:"equipment-types"},$e=["onClick"],xe={class:"materials-selection"},Ie={class:"materials-list"},Le=["onClick"],Ee={key:0,class:"selected-materials"},qe={class:"selected-list"},Te=["onClick"],je=["disabled"],Re={key:0,class:"equipment-stats"};function Se(k,l,s,t,f,r){return p(),_("div",be,[i("div",we,[i("div",ke,[l[2]||(l[2]=i("div",{class:"forge-title"},"装备锻造",-1)),i("button",{class:"close-button",onClick:l[0]||(l[0]=ne((...a)=>t.handleCloseClick&&t.handleCloseClick(...a),["stop"]))},"×")]),i("div",Ce,[l[3]||(l[3]=i("div",{class:"section-title"},"选择装备类型",-1)),i("div",Me,[(p(!0),_(D,null,Y(t.equipmentTypes,(a,u)=>(p(),_("div",{key:u,class:z(["equipment-type-item",{selected:t.selectedType===u}]),onClick:v=>t.selectEquipmentType(u)},R(a.name),11,$e))),128))])]),i("div",xe,[l[4]||(l[4]=i("div",{class:"section-title"},"选择材料 (1-5件)",-1)),i("div",Ie,[(p(!0),_(D,null,Y(t.availableMaterials,(a,u)=>(p(),_("div",{key:u,class:z(["material-item",{selected:t.selectedMaterials.some(v=>v.index===u)}]),onClick:v=>t.toggleMaterial(a,u)},R(t.getMaterialName(a)),11,Le))),128))])]),t.selectedMaterials.length>0?(p(),_("div",Ee,[l[5]||(l[5]=i("div",{class:"section-title"},"已选材料",-1)),i("div",qe,[(p(!0),_(D,null,Y(t.selectedMaterials,(a,u)=>(p(),_("div",{key:u,class:"selected-item"},[ae(R(t.getMaterialName(a.material))+" ",1),i("button",{onClick:v=>t.removeMaterial(a.index)},"移除",8,Te)]))),128))])])):S("",!0),i("button",{class:"forge-button",onClick:l[1]||(l[1]=(...a)=>t.startForge&&t.startForge(...a)),disabled:t.selectedMaterials.length===0||t.selectedMaterials.length>5}," 开始锻造 ",8,je),t.forgeResult?(p(),_("div",{key:1,class:z(["forge-result",t.forgeResult.success?"success":"fail"])},[l[6]||(l[6]=i("div",{class:"section-title"},"锻造结果",-1)),i("p",null,R(t.forgeResult.message),1),t.forgeResult.equipment?(p(),_("div",Re,[i("p",null,"获得装备："+R(t.forgeResult.equipment.name),1)])):S("",!0)],2)):S("",!0)])])}const Ne=G(_e,[["render",Se],["__scopeId","data-v-143880b7"]]),Pe={class:"shop-view-container"},Oe={class:"shop-content"},Ve={class:"shop-section"},Be={class:"shop-grid"},Fe=["onClick"],Ae={class:"item-name"},We={class:"item-price"},De={class:"inventory-section"},Ye={class:"inventory-grid"},Xe=["onClick"],He={class:"item-name"},ze={class:"item-price"},Ue={key:0,class:"item-count"},Ke={__name:"ShopView",emits:["close"],setup(k,{emit:l}){const s=l,t=F(()=>U[M.currentMapId]),f=F(()=>{var o;return(o=t.value)==null?void 0:o.locations[M.currentLocationId]}),r=F(()=>{var g,d,$;return((($=(d=(g=f.value)==null?void 0:g.npc)==null?void 0:d.shop)==null?void 0:$.items)||[]).map(j=>{const T=me.potions[j.id];return{...j,name:T.name,description:T.description,effect:T.effect}})}),a=F(()=>{const g=(M.player.materials||[]).reduce((d,$)=>(d[$]=(d[$]||0)+1,d),{});return Object.entries(g).map(([d,$])=>{for(const j of Object.values(N.material_types)){const T=j.materials[d];if(T)return{id:d,name:T.name,level:T.level,type:j.name,count:$}}return null}).filter(Boolean)}),u=o=>100*o.level,v=L(!1),x=L(""),y=L("info"),n=L(!1),e=L("确定"),C=L(()=>{}),m=o=>{x.value=`${o.name}<br>${o.description}<br>价格: ${o.price} 金币`,y.value="info",v.value=!0,n.value=!0,e.value="购买",C.value=()=>b(o)},w=o=>{const g=u(o),d=g*o.count;x.value=`${o.name}<br>类型: ${o.type}<br>等级: ${o.level}<br>数量: ${o.count}<br>单价: ${g} 金币<br>总价: ${d} 金币`,y.value="info",v.value=!0,n.value=!0,e.value="批量出售",C.value=()=>E(o)},b=async o=>{if(M.player.gold<o.price){K(()=>{x.value="金币不足！",y.value="error",n.value=!1,v.value=!0});return}const g={...M.player};g.gold-=o.price,g.potions.push(o.id),await J(g),K(()=>{x.value="购买成功！",y.value="success",n.value=!1,v.value=!0})},E=async o=>{const d=u(o)*o.count,$={...M.player};$.gold+=d,$.materials=$.materials.filter(j=>j!==o.id),await J($),K(()=>{x.value=`批量出售成功！获得 ${d} 金币`,y.value="success",n.value=!1,v.value=!0})},P=()=>{C.value()},V=()=>{s("close")};return(o,g)=>(p(),_("div",Pe,[i("div",{class:"shop-header"},[g[1]||(g[1]=i("div",{class:"title"},"商店",-1)),i("div",{class:"close-button",onClick:V},"×")]),i("div",Oe,[i("div",Ve,[i("div",Be,[(p(!0),_(D,null,Y(r.value,d=>(p(),_("div",{key:d.id,class:"shop-item",onClick:$=>m(d)},[i("div",Ae,R(d.name),1),i("div",We,R(d.price)+" 金币",1)],8,Fe))),128))])]),i("div",De,[i("div",Ye,[(p(!0),_(D,null,Y(a.value,d=>(p(),_("div",{key:d.id,class:"inventory-item",onClick:$=>w(d)},[i("div",He,R(d.name),1),i("div",ze,R(u(d))+" 金币",1),d.count>1?(p(),_("div",Ue,"x"+R(d.count),1)):S("",!0)],8,Xe))),128))])])]),ee(te,{visible:v.value,"onUpdate:visible":g[0]||(g[0]=d=>v.value=d),content:x.value,type:y.value,"show-button":n.value,"button-text":e.value,onAction:P},null,8,["visible","content","type","show-button","button-text"])]))}},Ge=G(Ke,[["__scopeId","data-v-d2262c67"]]),Je={class:"location-container"},Qe={class:"content-wrapper"},Ze={class:"location-header"},et={class:"location-title"},tt={class:"combat-log"},st={class:"combat-log-content"},nt={key:0,class:"tab-container"},ot={key:1,class:"enemies-list"},at={key:0,class:"enemies-list-content"},it=["onClick"],lt=["onClick","disabled"],ct={key:1,class:"empty-enemies"},rt={key:2,class:"npcs-list"},ut={class:"npcs-list-content"},dt=["onClick"],vt={key:0,class:"enter-button"},mt={__name:"LocationView",emits:["close"],setup(k,{emit:l}){const s=L("enemies"),t=L([]);ie();const f=F(()=>U[M.currentMapId].locations[M.currentLocationId]),r=L([]),a=L(!1),u=()=>{const c=M.enemyStatus[M.currentLocationId]||{},h=f.value.enemy||{},I=Object.entries(c).filter(([O,W])=>{const X=W.enemyId,H=h[X];return H?Math.random()<H.probability:!1}).map(([O,W])=>({instanceId:O,name:le.creatures[W.enemyId].name,enemy:W})),B=Math.min(5,I.length);t.value=I.sort(()=>Math.random()-.5).slice(0,B)},v=l;oe(()=>{r.value.push({id:Date.now(),message:`${f.value.description||""}`}),d(),u()});const x=()=>{v("close")},y=c=>({forge:"锻造所",shop:"商店"})[c]||c,n=L(!1),e=L(!1),C=c=>{c==="forge"?n.value=!0:c==="shop"&&(e.value=!0)},m=()=>{n.value=!1},w=()=>{e.value=!1},b=(c,q=500)=>new Promise(h=>{setTimeout(()=>{r.value.push({id:Date.now(),message:c}),h()},q)}),E=async c=>{var q;if(!a.value){a.value=!0;try{const h=await re(c.instanceId);if(!h.player.hit)await b(`你的攻击未命中${c.name}`);else{let I=`你对${c.name}造成了${h.player.damage}点伤害`;if(h.player.isCrit&&(I+="（暴击！）"),await b(I),!((q=M.enemyStatus[M.currentLocationId])!=null&&q[c.instanceId])){if(await b(`${c.name}被击败了！`),h.droppedItems&&h.droppedItems.length>0){const B=h.droppedItems.map(O=>{for(const W in N.material_types){const X=N.material_types[W];if(X.materials[O])return X.materials[O].name}return O}).join("、");await b(`获得了：${B}`)}u();return}}if(h.enemy)if(!h.enemy.hit)await b(`${c.name}的反击未命中你`);else{let I=`${c.name}反击对你造成了${h.enemy.damage}点伤害`;if(h.enemy.isCrit&&(I+="（暴击！）"),await b(I),!h.enemy.isPlayerAlive){await b("你被击败了，装备材料掉了一地，太可惜了");return}}}catch(h){console.error("Attack failed:",h),await b("你脚下一滑，攻击没有发起")}finally{a.value=!1}}};Z(r,()=>{K(()=>{const c=document.querySelector(".combat-log-content");c&&(c.scrollTop=c.scrollHeight)})},{deep:!0});const V=F(()=>t.value.length>0),o=F(()=>f.value.enemy&&Object.keys(f.value.enemy).length>0),g=F(()=>f.value.npc&&Object.keys(f.value.npc).length>0),d=()=>{s.value==="enemies"&&!o.value?s.value=g.value?"npcs":null:s.value==="npcs"&&!g.value&&(s.value=o.value?"enemies":null)},$=L(!1),j=L(""),T=c=>{const q=c.enemy.enemyId,h=ce(q);let I=`${c.name}<br>`;for(const[B,O]of Object.entries(h))I+=`${A.combat_stats[B]}: ${O}<br>`;j.value=I.trim(),$.value=!0};return(c,q)=>(p(),_("div",null,[i("div",{class:"overlay",onClick:x}),i("div",Je,[i("div",Qe,[i("div",Ze,[i("div",et,R(f.value.name),1)]),i("div",tt,[q[3]||(q[3]=i("div",{class:"section-title"},"探索日志",-1)),i("div",st,[(p(!0),_(D,null,Y(r.value,h=>(p(),_("div",{key:h.id},R(h.message),1))),128))])]),o.value||g.value?(p(),_("div",nt,[o.value?(p(),_("div",{key:0,class:z(["tab-item",{active:s.value==="enemies"}]),onClick:q[0]||(q[0]=h=>s.value="enemies")}," 生物列表 ",2)):S("",!0),g.value?(p(),_("div",{key:1,class:z(["tab-item",{active:s.value==="npcs"}]),onClick:q[1]||(q[1]=h=>s.value="npcs")}," NPC列表 ",2)):S("",!0)])):S("",!0),s.value==="enemies"?(p(),_("div",ot,[V.value?(p(),_("div",at,[(p(!0),_(D,null,Y(t.value,h=>(p(),_("div",{key:h.instanceId,class:"enemy-item",onClick:I=>T(h)},[i("span",null,R(h.name)+" (HP: "+R(h.enemy.hp)+")",1),i("button",{onClick:ne(I=>E(h),["stop"]),disabled:a.value}," 攻击 ",8,lt)],8,it))),128))])):(p(),_("div",ct,[i("span",{class:"explore-button",onClick:u}," 继续探索 ")]))])):S("",!0),s.value==="npcs"&&f.value.npc&&g.value?(p(),_("div",rt,[i("div",ut,[(p(!0),_(D,null,Y(f.value.npc,(h,I)=>(p(),_("div",{key:I,class:"npc-item",onClick:B=>C(I)},[i("span",null,R(y(I)),1),I==="forge"||I==="shop"?(p(),_("button",vt,"进入")):S("",!0)],8,dt))),128))])])):S("",!0)])]),n.value?(p(),Q(Ne,{key:0,class:"npc-view",onClose:m})):S("",!0),e.value?(p(),Q(Ge,{key:1,class:"npc-view",onClose:w})):S("",!0),ee(te,{visible:$.value,"onUpdate:visible":q[2]||(q[2]=h=>$.value=h),content:j.value,type:"info","show-button":!1},null,8,["visible","content"])]))}},pt=G(mt,[["__scopeId","data-v-79b18b78"]]),ft=async k=>{const l=M.currentLocationId;if(l===k)return;const s=U[M.currentMapId].locations[l],t=U[M.currentMapId].locations[k];if(!s||!t)return Promise.reject(new Error("无效的位置ID"));if(!s.adjacent_locations.includes(Number(k)))return Promise.reject(new Error(`无法移动到${t.name}，该位置与当前位置不相邻`));const f=Math.sqrt(Math.pow(t.position.x-s.position.x,2)+Math.pow(t.position.y-s.position.y,2)),r=Math.floor(f/50*1e3);await new Promise(a=>{setTimeout(()=>{a()},r)}),ue({currentLocationId:k})},ht={__name:"MapView",setup(k){const l=L(null),s=L(!1),t=U[M.currentMapId],f=t.locations,r=L(!1),a=L(""),u=(n,e,C,m,w,b,E,P,V)=>{const o=Math.atan2(m-e,C-n),g=w+E/2,d=b+P/2,$=E/2,j=P/2;let T,c;return Math.abs(Math.tan(o))*$<=j?(T=Math.cos(o)>0?w+E:w,c=d+Math.tan(o)*(T-g)):(c=Math.sin(o)>0?b+P:b,T=g+(c-d)/Math.tan(o)),{x:T,y:c}},v=()=>{const n=l.value,e=n.getContext("2d");e.clearRect(0,0,n.width,n.height),e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(0,0,n.width,n.height);const C=new Set;Object.values(f).forEach(m=>{const w=m.position.x,b=m.position.y;e.font="16px Arial",e.textAlign="center";const E=m.name||"未命名",P=e.measureText(E).width,V=10,o=P+V*2,g=30,d=w-o/2,$=b-g/2;m.adjacent_locations.forEach(j=>{const T=[m.id,j].sort().join("-");if(!C.has(T)){const c=f[j];if(c){const q=c.name||"未命名",I=e.measureText(q).width+V*2,B=30,O=c.position.x-I/2,W=c.position.y-B/2,X=u(w,b,c.position.x,c.position.y,d,$,o,g),H=u(c.position.x,c.position.y,w,b,O,W,I,B);e.beginPath(),e.moveTo(X.x,X.y),e.lineTo(H.x,H.y),e.strokeStyle="#ffd700",e.lineWidth=2,e.stroke(),C.add(T)}}}),e.beginPath(),e.strokeStyle=M.currentLocationId===m.id?"#ff4444":"#ffd700",e.lineWidth=2,e.roundRect(d,$,o,g,8),e.stroke(),Number(M.currentLocationId)===Number(m.id)&&(e.save(),e.shadowColor="#ff4444",e.shadowBlur=10,e.shadowOffsetX=0,e.shadowOffsetY=0,e.strokeStyle="#ff4444",e.lineWidth=2,e.roundRect(d,$,o,g,8),e.stroke(),e.restore()),e.fillStyle="white",e.fillText(E,w,b+5)})},x=async n=>{const C=l.value.getBoundingClientRect(),m=n.clientX-C.left,w=n.clientY-C.top;Object.keys(f).forEach(async b=>{const E=f[b],P=E.position.x,V=E.position.y;if(Math.abs(m-P)<20&&Math.abs(w-V)<20)try{r.value=!0,a.value=`正在前往${E.name}...`,await ft(b),r.value=!1,s.value=!0}catch(o){a.value=o.message,setTimeout(()=>{r.value=!1},2e3)}})},y=()=>{const e=l.value.parentElement,C=f[M.currentLocationId];if(C){const m=C.position.x,w=C.position.y,b=m-e.clientWidth/2,E=w-e.clientHeight/2;e.scrollTo({left:b,top:E,behavior:"smooth"})}};return oe(()=>{const n=l.value;n.width=t.width,n.height=t.height,v(),n.addEventListener("click",x),y()}),Z(()=>M.currentLocationId,v),(n,e)=>(p(),_("div",{class:"map-container",style:de({backgroundImage:`url(${ve(t).bg_image})`})},[i("canvas",{ref_key:"mapCanvas",ref:l,class:"map-canvas"},null,512),s.value?(p(),Q(pt,{key:0,onClose:e[0]||(e[0]=C=>s.value=!1)})):S("",!0),i("button",{class:"focus-button",onClick:y},e[2]||(e[2]=[i("span",{class:"focus-icon"},"📍",-1)])),ee(te,{visible:r.value,"onUpdate:visible":e[1]||(e[1]=C=>r.value=C),content:a.value,type:"info","show-button":!1,"allow-close":!1},null,8,["visible","content"])],4))}},bt=G(ht,[["__scopeId","data-v-4ea0c04e"]]);export{bt as default};
